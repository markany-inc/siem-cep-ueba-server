<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SafePC SIEM</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * { font-family: 'Inter', sans-serif; }
        .nav-menu { position: relative; }
        .nav-item { 
            padding: 8px 16px; 
            font-size: 14px; 
            font-weight: 500; 
            border-radius: 8px; 
            transition: all 0.2s; 
            cursor: pointer;
            color: white;
        }
        .nav-item:hover { 
            background: white !important; 
            color: #1e293b !important; 
        }
        .nav-item.active { 
            background: #3b82f6; 
            color: white; 
        }
        .nav-item.active:hover { 
            background: #2563eb !important; 
            color: white !important; 
        }
        .dropdown { 
            position: absolute; 
            top: 100%; 
            left: 0; 
            margin-top: 4px; 
            background: white; 
            border-radius: 8px; 
            box-shadow: 0 10px 25px rgba(0,0,0,0.15); 
            border: 1px solid #e5e7eb; 
            padding: 4px 0; 
            min-width: 160px; 
            opacity: 0; 
            visibility: hidden; 
            transition: all 0.2s; 
        }
        .nav-menu:hover .dropdown { opacity: 1; visibility: visible; }
        .dropdown a { display: block; padding: 8px 16px; font-size: 14px; color: #374151; }
        .dropdown a:hover { background: #f3f4f6; }
        .dropdown a.active { background: #eff6ff; color: #1d4ed8; font-weight: 500; }
        a { cursor: pointer; }
        .help-tip { position: relative; display: inline-flex; align-items: center; justify-content: center; width: 16px; height: 16px; border-radius: 50%; background: #e5e7eb; color: #6b7280; font-size: 11px; cursor: help; margin-left: 6px; }
        .help-tip:hover .help-tooltip { opacity: 1; visibility: visible; }
        .help-tooltip { position: absolute; top: 24px; left: 50%; transform: translateX(-50%); width: 280px; padding: 12px; background: #1f2937; color: white; font-size: 12px; line-height: 1.5; border-radius: 8px; opacity: 0; visibility: hidden; transition: all 0.2s; z-index: 100; box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
        .help-tooltip::before { content: ''; position: absolute; top: -6px; left: 50%; transform: translateX(-50%); border-left: 6px solid transparent; border-right: 6px solid transparent; border-bottom: 6px solid #1f2937; }
    </style>
</head>
<body class="bg-slate-100 min-h-screen">
    <nav class="bg-gradient-to-r from-slate-900 to-slate-800 text-white sticky top-0 z-50">
        <div class="max-w-[1600px] mx-auto px-6 py-3 flex items-center justify-between">
            <a href="/" class="text-xl font-bold tracking-tight">SafePC <span class="text-blue-400">SIEM</span></a>
            <div class="flex items-center gap-2">
                <a href="/" class="nav-item active">Dashboard</a>
                <div class="nav-menu">
                    <span class="nav-item">Monitoring â–¾</span>
                    <div class="dropdown">
                        <a href="/alerts">Alert History</a>
                        <a href="/logs">Event Logs</a>
                    </div>
                </div>
                <a href="/users" class="nav-item">User Risk</a>
                <a href="/rules" class="nav-item">CEP Rules</a>
                <a href="/settings" class="nav-item">UEBA Settings</a>
            </div>
        </div>
    </nav>

    <main class="max-w-[1600px] mx-auto px-6 py-5">
        <!-- Stats Section -->
        <section class="grid grid-cols-2 gap-5 mb-5">
            <!-- Alert í†µê³„ -->
            <div class="bg-white rounded-2xl p-5 shadow-sm">
                <div class="flex items-center justify-between mb-4">
                    <div class="flex items-center">
                        <h2 class="text-sm font-semibold text-gray-900">ì´ìƒí–‰ìœ„ íƒì§€ (CEP)</h2>
                        <span class="help-tip">?<div class="help-tooltip">Flink CEP ì‹¤ì‹œê°„ ìŠ¤íŠ¸ë¦¼ ì²˜ë¦¬<br>â€¢ Kafka ì´ë²¤íŠ¸ ìˆ˜ì‹  ì¦‰ì‹œ ë£° ë§¤ì¹­<br>â€¢ 5ë¶„ ìœˆë„ìš° ê¸°ë°˜ íŒ¨í„´ íƒì§€<br>â€¢ Alert ë°œìƒ ì‹œ OpenSearch ì €ì¥ ë° WebSocket í‘¸ì‹œ</div></span>
                    </div>
                    <span class="text-xs text-gray-400">today</span>
                </div>
                {% set alert_buckets = alerts.get('aggregations', {}).get('bySeverity', {}).get('buckets', []) %}
                {% set critical = alert_buckets | selectattr('key', 'equalto', 'CRITICAL') | list %}
                {% set high = alert_buckets | selectattr('key', 'equalto', 'HIGH') | list %}
                {% set medium = alert_buckets | selectattr('key', 'equalto', 'MEDIUM') | list %}
                <div class="grid grid-cols-4 gap-2">
                    <a href="/alerts?severity=CRITICAL" class="bg-red-50 rounded-xl p-3 hover:bg-red-100 transition-colors text-center">
                        <div class="text-2xl font-bold text-red-700">{{ "{:,}".format(critical[0].doc_count if critical else 0) }}<span class="text-sm font-medium ml-1">ê±´</span></div>
                        <div class="text-xs font-medium text-red-600 mt-1">ê¸´ê¸‰</div>
                    </a>
                    <a href="/alerts?severity=HIGH" class="bg-orange-50 rounded-xl p-3 hover:bg-orange-100 transition-colors text-center">
                        <div class="text-2xl font-bold text-orange-700">{{ "{:,}".format(high[0].doc_count if high else 0) }}<span class="text-sm font-medium ml-1">ê±´</span></div>
                        <div class="text-xs font-medium text-orange-600 mt-1">ì£¼ì˜</div>
                    </a>
                    <a href="/alerts?severity=MEDIUM" class="bg-amber-50 rounded-xl p-3 hover:bg-amber-100 transition-colors text-center">
                        <div class="text-2xl font-bold text-amber-700">{{ "{:,}".format(medium[0].doc_count if medium else 0) }}<span class="text-sm font-medium ml-1">ê±´</span></div>
                        <div class="text-xs font-medium text-amber-600 mt-1">ë³´í†µ</div>
                    </a>
                    <a href="/logs" class="bg-blue-50 rounded-xl p-3 hover:bg-blue-100 transition-colors text-center">
                        <div class="text-2xl font-bold text-blue-700">{{ "{:,}".format(logs.get('hits', {}).get('total', {}).get('value', 0) | int) }}<span class="text-sm font-medium ml-1">ê±´</span></div>
                        <div class="text-xs font-medium text-blue-600 mt-1">ì´ë²¤íŠ¸</div>
                    </a>
                </div>
            </div>
            <!-- UEBA í†µê³„ -->
            <div class="bg-white rounded-2xl p-5 shadow-sm">
                <div class="flex items-center justify-between mb-4">
                    <div class="flex items-center">
                        <h2 class="text-sm font-semibold text-gray-900">ì‚¬ìš©ì ìœ„í—˜ë„ (UEBA)</h2>
                        <span class="help-tip">?<div class="help-tooltip">ì‚¬ìš©ì í–‰ë™ ë¶„ì„ (UEBA)<br>â€¢ <b>ì‹¤ì‹œê°„</b> Kafka ì´ë²¤íŠ¸ ê¸°ë°˜ ìŠ¤ì½”ì–´ë§<br>â€¢ ìì •ë§ˆë‹¤ ì‹œê°„ ê°ì‡ (Ã—0.9) ì ìš©<br>â€¢ 7ì¼ í‰ê·  ê¸°ì¤€ ì´ìƒì¹˜(Z-Score) íƒì§€<br>â€¢ ì ìˆ˜ = ì´ë²¤íŠ¸ ê°€ì¤‘ì¹˜ + ì´ìƒì¹˜ + ì „ì¼ ê°ì‡ </div></span>
                    </div>
                    <span class="text-xs text-gray-400">{{ ueba_last_update }}</span>
                </div>
                <div class="grid grid-cols-3 gap-2">
                    <a href="/users?level=HIGH" class="bg-red-50 rounded-xl p-3 hover:bg-red-100 transition-colors text-center">
                        <div class="text-2xl font-bold text-red-700">{{ "{:,}".format(level_counts.HIGH) }}<span class="text-sm font-medium ml-1">ëª…</span></div>
                        <div class="text-xs font-medium text-red-600 mt-1">ìœ„í—˜</div>
                    </a>
                    <a href="/users?level=MEDIUM" class="bg-amber-50 rounded-xl p-3 hover:bg-amber-100 transition-colors text-center">
                        <div class="text-2xl font-bold text-amber-700">{{ "{:,}".format(level_counts.MEDIUM) }}<span class="text-sm font-medium ml-1">ëª…</span></div>
                        <div class="text-xs font-medium text-amber-600 mt-1">ì£¼ì˜</div>
                    </a>
                    <a href="/users?level=LOW" class="bg-green-50 rounded-xl p-3 hover:bg-green-100 transition-colors text-center">
                        <div class="text-2xl font-bold text-green-700">{{ "{:,}".format(level_counts.LOW) }}<span class="text-sm font-medium ml-1">ëª…</span></div>
                        <div class="text-xs font-medium text-green-600 mt-1">ê´€ì‹¬</div>
                    </a>
                </div>
            </div>
        </section>

        <!-- Content Grid -->
        <section class="grid grid-cols-3 gap-5 mb-5">
            <!-- Recent Alerts -->
            <div class="col-span-2 bg-white rounded-2xl shadow-sm overflow-hidden">
                <div class="px-5 py-4 border-b border-gray-100 flex items-center justify-between">
                    <div class="flex items-center">
                        <h2 class="text-sm font-semibold text-gray-900">ìµœê·¼ ì´ìƒí–‰ìœ„ íƒì§€</h2>
                        <span class="help-tip">?<div class="help-tooltip">CEP ì‹¤ì‹œê°„ íƒì§€ ê²°ê³¼<br>â€¢ ìµœê·¼ 10ê±´ í‘œì‹œ<br>â€¢ í´ë¦­ ì‹œ ì‚¬ìš©ì ìƒì„¸ í˜ì´ì§€ ì´ë™<br>â€¢ ì „ì²´ ë³´ê¸°ì—ì„œ í•„í„°/ê²€ìƒ‰ ê°€ëŠ¥</div></span>
                    </div>
                    <a href="/alerts" class="text-xs font-medium text-blue-600 hover:text-blue-800">ì „ì²´ ë³´ê¸° â†’</a>
                </div>
                <div class="overflow-auto" style="max-height: 320px;">
                    <table class="w-full">
                        <thead class="bg-gray-50 sticky top-0">
                            <tr class="text-xs font-semibold text-gray-600 border-b-2 border-gray-200">
                                <th class="px-4 py-3 text-left">ì‹œê°„ (KST)</th>
                                <th class="px-4 py-3 text-left">íƒì§€ ë£°</th>
                                <th class="px-4 py-3 text-left">ì‚¬ìš©ì</th>
                                <th class="px-4 py-3 text-left">í˜¸ìŠ¤íŠ¸</th>
                                <th class="px-4 py-3 text-left">ì„¤ëª…</th>
                                <th class="px-4 py-3 text-left">ë“±ê¸‰</th>
                            </tr>
                        </thead>
                        <tbody id="alert-tbody" class="divide-y divide-gray-100">
                            {% for alert in recent_alerts %}
                            {% set a = alert._source %}
                            {% set ts = a['@timestamp'] %}
                            <tr class="hover:bg-gray-50 transition-colors">
                                <td class="px-4 py-3 text-sm text-gray-500 whitespace-nowrap font-mono">{{ ts | kst }}</td>
                                <td class="px-4 py-3">
                                    <div class="text-sm font-medium text-gray-900">{{ a.RuleName or a.ruleName }}</div>
                                </td>
                                <td class="px-4 py-3">
                                    <a href="/user/{{ a.UserId or a.userId }}" class="text-sm text-blue-600 hover:text-blue-800">{{ a.UserId or a.userId }}</a>
                                </td>
                                <td class="px-4 py-3 text-sm text-gray-500">{{ a.Hostname or a.hostname or '-' }}</td>
                                <td class="px-4 py-3 text-sm text-gray-600 max-w-[200px] truncate" title="{{ a.description }}">{{ a.description or a.ruleName or a.RuleName or '-' }}</td>
                                <td class="px-4 py-3">
                                    {% if a.Severity or a.severity == 'CRITICAL' %}<span class="px-2 py-1 text-xs font-medium rounded-full bg-red-100 text-red-700">ê¸´ê¸‰</span>
                                    {% elif a.Severity or a.severity == 'HIGH' %}<span class="px-2 py-1 text-xs font-medium rounded-full bg-orange-100 text-orange-700">ì£¼ì˜</span>
                                    {% elif a.Severity or a.severity == 'MEDIUM' %}<span class="px-2 py-1 text-xs font-medium rounded-full bg-amber-100 text-amber-700">ë³´í†µ</span>
                                    {% else %}<span class="px-2 py-1 text-xs font-medium rounded-full bg-gray-100 text-gray-600">ë‚®ìŒ</span>{% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Top Risk Users -->
            <div class="bg-white rounded-2xl shadow-sm overflow-hidden">
                <div class="px-5 py-4 border-b border-gray-100 flex items-center justify-between">
                    <div class="flex items-center">
                        <h2 class="text-sm font-semibold text-gray-900">ìœ„í—˜ë„ ë†’ì€ ì‚¬ìš©ì</h2>
                        <span class="help-tip">?<div class="help-tooltip">UEBA ìœ„í—˜ ì ìˆ˜ ìƒìœ„ 10ëª…<br>â€¢ <b>ì‹¤ì‹œê°„</b> ì´ë²¤íŠ¸ ë°œìƒ ì‹œ ê°±ì‹ <br>â€¢ ê´€ì‹¬(~40) / ì£¼ì˜(40~99) / ìœ„í—˜(99+)<br>â€¢ ë³€í™”: ì „ì¼ ëŒ€ë¹„ ì ìˆ˜ ì¦ê°<br>â€¢ í´ë¦­ ì‹œ ìƒì„¸ í–‰ë™ ë¶„ì„ í™•ì¸</div></span>
                    </div>
                    <a href="/users" class="text-xs font-medium text-blue-600 hover:text-blue-800">ì „ì²´ ë³´ê¸° â†’</a>
                </div>
                <div class="overflow-auto" style="max-height: 320px;">
                    <table class="w-full">
                        <thead class="bg-gray-50 sticky top-0">
                            <tr class="text-xs font-semibold text-gray-600 border-b-2 border-gray-200">
                                <th class="px-4 py-3 text-left">ì‚¬ìš©ì</th>
                                <th class="px-4 py-3 text-left">ì ìˆ˜</th>
                                <th class="px-4 py-3 text-left">ë“±ê¸‰</th>
                                <th class="px-4 py-3 text-left">ë³€í™”</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-100">
                            {% for user in top_users %}
                            <tr class="hover:bg-gray-50 transition-colors">
                                <td class="px-4 py-3"><a href="/user/{{ user.userId }}" class="text-sm text-blue-600 hover:text-blue-800 font-medium">{{ user.userId }}</a></td>
                                <td class="px-4 py-3 text-sm font-bold {% if user.riskScore > tiers.red_max|default(150) %}text-red-600{% elif user.riskScore > tiers.yellow_max|default(99) %}text-orange-600{% elif user.riskScore > tiers.green_max|default(40) %}text-amber-600{% else %}text-green-600{% endif %}">{{ "%.2f"|format(user.riskScore) }}ì </td>
                                <td class="px-4 py-3">
                                    {% if user.riskLevel == 'HIGH' %}<span class="px-2 py-1 text-xs font-medium rounded-full bg-red-100 text-red-700">ìœ„í—˜</span>
                                    {% elif user.riskLevel == 'MEDIUM' %}<span class="px-2 py-1 text-xs font-medium rounded-full bg-amber-100 text-amber-700">ì£¼ì˜</span>
                                    {% else %}<span class="px-2 py-1 text-xs font-medium rounded-full bg-green-100 text-green-700">ê´€ì‹¬</span>{% endif %}
                                </td>
                                <td class="px-4 py-3 text-xs font-medium {% if user.scoreDiff > 0 %}text-red-500{% elif user.scoreDiff < 0 %}text-blue-500{% else %}text-gray-400{% endif %}">
                                    {% if user.scoreDiff > 0 %}â–²+{{ "%.2f"|format(user.scoreDiff) }}{% elif user.scoreDiff < 0 %}â–¼{{ "%.2f"|format(user.scoreDiff) }}{% else %}Â±0.00{% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- Charts Section -->
        <section class="bg-white rounded-2xl p-5 shadow-sm">
            <div class="grid grid-cols-2 gap-6">
                <div>
                    <div class="flex items-center justify-between mb-4">
                        <div class="flex items-center">
                            <h2 class="text-sm font-semibold text-gray-900">ì´ìƒí–‰ìœ„ íƒì§€ ìœ í˜•ë³„ í˜„í™©</h2>
                            <span class="help-tip">?<div class="help-tooltip">CEP ë£°ë³„ íƒì§€ ê±´ìˆ˜ (ì˜¤ëŠ˜)<br>â€¢ ë§‰ëŒ€ í´ë¦­ ì‹œ í•´ë‹¹ ë£° Alert í•„í„°</div></span>
                        </div>
                        <span class="text-xs text-gray-400">today</span>
                    </div>
                    <div style="height: 200px;" id="ruleChartWrap"><canvas id="ruleChart"></canvas></div>
                </div>
                <div>
                    <div class="flex items-center justify-between mb-4">
                        <div class="flex items-center">
                            <h2 class="text-sm font-semibold text-gray-900">ì´ë²¤íŠ¸ ìœ í˜• ë¶„í¬</h2>
                            <span class="help-tip">?<div class="help-tooltip">SafePC ìˆ˜ì§‘ ì´ë²¤íŠ¸ ë¶„í¬ (ì˜¤ëŠ˜)<br>â€¢ ì—ì´ì „íŠ¸, ì¥ì¹˜, í”„ë¡œì„¸ìŠ¤ ë“±<br>â€¢ ìƒìœ„ 6ê°œ ìœ í˜• í‘œì‹œ</div></span>
                        </div>
                        <span class="text-xs text-gray-400">today</span>
                    </div>
                    <div style="height: 200px;" id="eventChartWrap"><canvas id="eventChart"></canvas></div>
                </div>
            </div>
        </section>
    </main>

    <script>
        // ë£° ID â†’ í•œê¸€ ë¶„ë¥˜ ë§¤í•‘
        const ruleCategory = {
            'AU-001': 'ì¸ì¦ ì‹¤íŒ¨', 'AU-002': 'ë¹„ì—…ë¬´ì‹œê°„ ì ‘ì†', 'AU-003': 'ì£¼ë§ ì ‘ì†',
            'AG-001': 'ì—ì´ì „íŠ¸ ì‚­ì œ', 'AG-002': 'ì—…ë°ì´íŠ¸ ì‹¤íŒ¨',
            'DV-001': 'USB ë°˜ì¶œ', 'NW-001': 'ëŒ€ìš©ëŸ‰ ì „ì†¡', 'NW-002': 'ì°¨ë‹¨ì‚¬ì´íŠ¸', 'NW-003': 'ë©”ì‹ ì € ì‚¬ìš©',
            'PR-001': 'ì•…ì„±ì½”ë“œ', 'PT-001': 'ëŒ€ëŸ‰ ì¸ì‡„',
            'CB-001': 'í´ë¦½ë³´ë“œ ì°¨ë‹¨', 'CP-001': 'í™”ë©´ìº¡ì²˜ ì°¨ë‹¨',
            'SC-001': 'ë¶ˆë²•ì´¬ì˜ íƒì§€', 'SC-002': 'ìë¦¬ì´íƒˆ',
            'PC-001': 'IP ë³€ê²½', 'DR-001': 'DRM ë³µí˜¸í™”'
        };
        
        const ruleData = {{ alerts.get('aggregations', {}).get('byRule', {}).get('buckets', []) | tojson }};
        const eventData = {{ logs.get('aggregations', {}).get('byType', {}).get('buckets', [])[:6] | tojson }};
        
        if (ruleData.length === 0) {
            document.getElementById('ruleChartWrap').innerHTML = '<div class="flex items-center justify-center h-full text-gray-400 text-sm">íƒì§€ëœ ì´ìƒí–‰ìœ„ê°€ ì—†ìŠµë‹ˆë‹¤</div>';
        } else {
            new Chart(document.getElementById('ruleChart'), {
                type: 'bar', 
                data: { 
                    labels: ruleData.map(d => [d.key, ruleCategory[d.key] || '']), 
                    datasets: [{ data: ruleData.map(d => d.doc_count), backgroundColor: '#3b82f6', borderRadius: 4 }] 
                },
                options: { maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, ticks: { stepSize: 1 }, grid: { color: '#f3f4f6' } }, x: { grid: { display: false } } } }
            });
        }
        
        const eventLabels = { 'MESSAGE_AGENT': 'ì—ì´ì „íŠ¸', 'MESSAGE_NETWORK': 'ë„¤íŠ¸ì›Œí¬', 'MESSAGE_DEVICE': 'ì¥ì¹˜', 'MESSAGE_PROCESS': 'í”„ë¡œì„¸ìŠ¤', 'MESSAGE_PRINT': 'ì¸ì‡„', 'MESSAGE_DRM': 'DRM', 'MESSAGE_CLIPBOARD': 'í´ë¦½ë³´ë“œ', 'MESSAGE_CAPTURE': 'í™”ë©´ìº¡ì²˜', 'MESSAGE_SCREENBLOCKER': 'í™”ë©´ë³´í˜¸', 'MESSAGE_PC': 'PCì„¤ì •', 'MESSAGE_ASSETS': 'ìì‚°' };
        
        if (eventData.length === 0) {
            document.getElementById('eventChartWrap').innerHTML = '<div class="flex items-center justify-center h-full text-gray-400 text-sm">ìˆ˜ì§‘ëœ ì´ë²¤íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤</div>';
        } else {
            new Chart(document.getElementById('eventChart'), {
                type: 'doughnut', 
                data: { 
                    labels: eventData.map(d => eventLabels[d.key] || d.key.replace('MESSAGE_', '')), 
                    datasets: [{ data: eventData.map(d => d.doc_count), backgroundColor: ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#ec4899'], borderWidth: 0 }] 
                },
                options: { maintainAspectRatio: false, cutout: '60%', plugins: { legend: { position: 'right', labels: { boxWidth: 12, padding: 12, font: { size: 11 } } } } }
            });
        }

        const ws = new WebSocket(`ws://${location.host}/ws`);
        const updateTime = () => {
            const t = new Date().toLocaleTimeString('ko-KR');
            ['stat-update', 'ueba-stat-update', 'alert-update', 'ueba-update'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.textContent = t + ' ê°±ì‹ ';
            });
        };
        updateTime(); ws.onopen = updateTime;
        ws.onmessage = (e) => {
            updateTime();
            const msg = JSON.parse(e.data);
            if (msg.type === 'alert') {
                const a = msg.data, tbody = document.getElementById('alert-tbody');
                const sev = {CRITICAL:['critical','ê¸´ê¸‰'],HIGH:['high','ì£¼ì˜'],MEDIUM:['medium','ë³´í†µ']}[a.Severity||a.severity]||['low','ë‚®ìŒ'];
                const row = document.createElement('tr'); row.className = 'bg-yellow-50 hover:bg-yellow-100 transition-colors';
                row.innerHTML = `<td class="px-5 py-3 text-sm text-gray-500">${new Date().toLocaleTimeString('ko-KR')}</td><td class="px-5 py-3"><div class="text-sm font-medium text-gray-900">${a.RuleName||a.ruleName}</div></td><td class="px-5 py-3"><a href="/user/${a.UserId||a.userId}" class="text-sm text-blue-600">${a.UserName||a.userName||a.UserId||a.userId}</a></td><td class="px-5 py-3"><span class="px-2 py-1 text-xs font-medium rounded-full ${sev[0]==='critical'?'bg-red-100 text-red-700':sev[0]==='high'?'bg-orange-100 text-orange-700':'bg-amber-100 text-amber-700'}">${sev[1]}</span></td>`;
                tbody.insertBefore(row, tbody.firstChild);
                if (tbody.children.length > 10) tbody.removeChild(tbody.lastChild);
                document.getElementById(a.Severity||a.severity==='CRITICAL'?'critical-count':'high-count').textContent = parseInt(document.getElementById(a.Severity||a.severity==='CRITICAL'?'critical-count':'high-count').textContent)+1;
                if (Notification.permission==='granted'&&['CRITICAL','HIGH'].includes(a.severity)) new Notification(`ğŸš¨ ${a.ruleName}`,{body:`${a.userId}: ${a.description}`});
            }
        };
        ws.onclose = () => setTimeout(() => location.reload(), 5000);
        if (Notification.permission === 'default') Notification.requestPermission();
    </script>
</body>
</html>
