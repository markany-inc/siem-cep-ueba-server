<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CEP Rules - SafePC SIEM</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * { font-family: 'Inter', sans-serif; }
        .nav-menu { position: relative; }
        .nav-item { padding: 8px 16px; font-size: 14px; font-weight: 500; border-radius: 8px; transition: all 0.2s; cursor: pointer; color: white; }
        .nav-item:hover { background: white; color: #1e293b; }
        .nav-item.active { background: #3b82f6; color: white; }
        .dropdown { position: absolute; top: 100%; left: 0; margin-top: 4px; background: white; border-radius: 8px; box-shadow: 0 10px 25px rgba(0,0,0,0.15); border: 1px solid #e5e7eb; padding: 4px 0; min-width: 160px; opacity: 0; visibility: hidden; transition: all 0.2s; }
        .nav-menu:hover .dropdown { opacity: 1; visibility: visible; }
        .dropdown a { display: block; padding: 8px 16px; font-size: 14px; color: #374151; }
        .dropdown a:hover { background: #f3f4f6; }
        table { width: 100%; border-collapse: collapse; table-layout: fixed; }
        th { font-size: 13px; font-weight: 600; color: #374151; background: #f9fafb; border-bottom: 2px solid #e5e7eb; padding: 12px 16px; text-align: left; }
        td { font-size: 13px; padding: 12px 16px; border-bottom: 1px solid #f3f4f6; }
        tr:hover { background: #f9fafb; }
        tr.editable { cursor: pointer; }
        tr.editable:hover { background: #eff6ff; }
        .badge { padding: 4px 10px; font-size: 12px; font-weight: 500; border-radius: 9999px; }
        .badge-critical { background: #fef2f2; color: #b91c1c; }
        .badge-high { background: #fff7ed; color: #c2410c; }
        .badge-medium { background: #fffbeb; color: #b45309; }
        .badge-low { background: #f0fdf4; color: #15803d; }
        .tab { padding: 10px 20px; font-size: 14px; font-weight: 500; cursor: pointer; border-bottom: 2px solid transparent; color: #6b7280; }
        .tab:hover { color: #374151; }
        .tab.active { color: #3b82f6; border-bottom-color: #3b82f6; }
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 100; align-items: center; justify-content: center; }
        .modal.show { display: flex; }
        .modal-content { background: white; border-radius: 12px; padding: 24px; width: 700px; max-width: 90%; max-height: 90vh; overflow-y: auto; }
        .form-group { margin-bottom: 16px; }
        .form-label { display: block; font-size: 13px; font-weight: 500; color: #374151; margin-bottom: 6px; }
        .form-input { width: 100%; padding: 10px 12px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 14px; }
        .form-input:focus { outline: none; border-color: #3b82f6; box-shadow: 0 0 0 3px rgba(59,130,246,0.1); }
        .form-input[readonly] { background: #f9fafb; }
        .form-hint { font-size: 11px; color: #6b7280; margin-top: 4px; }
        .form-select { width: 100%; padding: 10px 12px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 14px; background: white; }
        .btn { padding: 10px 20px; font-size: 14px; font-weight: 500; border-radius: 8px; cursor: pointer; transition: all 0.2s; border: none; }
        .btn-primary { background: #3b82f6; color: white; }
        .btn-primary:hover { background: #2563eb; }
        .btn-secondary { background: #f3f4f6; color: #374151; }
        .btn-secondary:hover { background: #e5e7eb; }
        /* UML Builder */
        .palette-node { display: flex; align-items: center; gap: 8px; padding: 10px 12px; background: white; border: 1px solid #e5e7eb; border-radius: 8px; cursor: grab; font-size: 13px; font-weight: 500; }
        .palette-node:hover { border-color: #3b82f6; background: #eff6ff; }
        .canvas-node { position: absolute; min-width: 160px; background: white; border: 2px solid #e5e7eb; border-radius: 10px; cursor: move; user-select: none; box-shadow: 0 2px 8px rgba(0,0,0,0.08); }
        .canvas-node:hover { border-color: #3b82f6; }
        .canvas-node.selected { border-color: #3b82f6; box-shadow: 0 0 0 3px rgba(59,130,246,0.2); }
        .canvas-node .node-header { padding: 8px 12px; border-bottom: 1px solid #f3f4f6; font-size: 12px; font-weight: 600; display: flex; align-items: center; gap: 6px; }
        .canvas-node .node-body { padding: 10px 12px; font-size: 12px; color: #6b7280; }
        .canvas-node.event { border-color: #10b981; }
        .canvas-node.event .node-header { background: #ecfdf5; color: #059669; }
        .canvas-node.condition { border-color: #f59e0b; border-radius: 10px; transform: rotate(0deg); }
        .canvas-node.condition .node-header { background: #fffbeb; color: #b45309; }
        .canvas-node.window { border-color: #8b5cf6; }
        .canvas-node.window .node-header { background: #f5f3ff; color: #7c3aed; }
        .canvas-node.action { border-color: #ef4444; }
        .canvas-node.action .node-header { background: #fef2f2; color: #dc2626; }
        .node-port { position: absolute; width: 16px; height: 16px; background: #3b82f6; border: 2px solid white; border-radius: 50%; cursor: crosshair; z-index: 10; }
        .node-port.in { top: 50%; left: -8px; transform: translateY(-50%); }
        .node-port.out { top: 50%; right: -8px; transform: translateY(-50%); }
        .node-delete { position: absolute; top: -8px; right: -8px; width: 20px; height: 20px; background: #ef4444; color: white; border-radius: 50%; font-size: 12px; cursor: pointer; display: none; align-items: center; justify-content: center; }
        .canvas-node:hover .node-delete { display: flex; }
    </style>
</head>
<body class="bg-slate-100 min-h-screen">
    <nav class="bg-gradient-to-r from-slate-900 to-slate-800 text-white sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-6 py-3 flex items-center justify-between">
            <a href="/" class="text-xl font-bold tracking-tight">SafePC <span class="text-blue-400">SIEM</span></a>
            <div class="flex items-center gap-2">
                <a href="/" class="nav-item">Dashboard</a>
                <div class="nav-menu">
                    <span class="nav-item">Monitoring â–¾</span>
                    <div class="dropdown">
                        <a href="/alerts">Alert History</a>
                        <a href="/logs">Event Logs</a>
                    </div>
                </div>
                <a href="/users" class="nav-item">User Risk</a>
                <a href="/rules" class="nav-item active">CEP Rules</a>
                <a href="/settings" class="nav-item">UEBA Settings</a>
            </div>
        </div>
    </nav>

    <main class="max-w-7xl mx-auto px-6 py-6">
        <div class="flex items-center justify-between mb-6">
            <div class="flex items-center gap-4">
                <h1 class="text-2xl font-bold text-gray-900">CEP íƒì§€ ê·œì¹™</h1>
                <span class="text-sm text-gray-500">í´ë¦­í•˜ì—¬ ê·œì¹™ ìˆ˜ì • ê°€ëŠ¥</span>
            </div>
            <div class="flex gap-2">
                <button onclick="openMigration()" class="btn btn-primary flex items-center gap-2">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg>
                    ë§ˆì´ê·¸ë ˆì´ì…˜
                </button>
                <button onclick="openRuleBuilder()" class="btn btn-primary flex items-center gap-2">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>
                    ê·œì¹™ ì¶”ê°€
                </button>
            </div>
        </div>

        <!-- CEP Rules Panel -->
        <div id="cep-panel" class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
            <div class="px-5 py-3 border-b border-gray-100 bg-gray-50">
                <h3 class="font-semibold text-gray-800">ì‹¤ì‹œê°„ ì´ë²¤íŠ¸ íƒì§€ ê·œì¹™ <span id="cepCount" class="text-xs text-gray-400"></span> <span class="text-xs text-blue-500 ml-2">í´ë¦­í•˜ì—¬ ìˆ˜ì •</span></h3>
            </div>
            <table id="cepTable">
                <thead>
                    <tr>
                        <th style="width:35%">ê·œì¹™ëª…</th>
                        <th style="width:80px">í™œì„±í™”</th>
                        <th style="width:80px">ë“±ê¸‰</th>
                        <th style="width:100px">ì¹´í…Œê³ ë¦¬</th>
                        <th>íƒì§€ ì¡°ê±´</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </main>

    <!-- ë§ˆì´ê·¸ë ˆì´ì…˜ ëª¨ë‹¬ -->
    <div id="migrationModal" class="modal">
        <div class="modal-content" style="width:98vw;max-width:1600px;height:95vh;display:flex;flex-direction:column;padding:0;">
            <div class="flex items-center justify-between px-5 py-3 border-b bg-slate-50">
                <div class="flex items-center gap-4">
                    <h3 class="text-lg font-semibold">ğŸ”„ í•„ë“œ ë©”íƒ€ë°ì´í„° ë§ˆì´ê·¸ë ˆì´ì…˜</h3>
                    <span id="migLastDate" class="text-xs text-gray-400"></span>
                </div>
                <button onclick="closeMigration()" class="text-gray-400 hover:text-gray-600 text-xl">&times;</button>
            </div>
            <!-- ë¶„ì„ ì„¤ì • ë°” -->
            <div class="px-5 py-3 border-b bg-blue-50 flex items-center gap-4 flex-wrap">
                <span class="text-sm font-medium text-gray-700">ë¶„ì„ ê¸°ê°„:</span>
                <input type="number" id="migDays" value="7" min="1" max="90" class="form-input text-sm w-20">
                <span class="text-sm text-gray-500">ì¼</span>
                <select id="migMode" class="form-input text-sm w-56">
                    <option value="merge">ê¸°ì¡´ ë°ì´í„°ì— ì¶”ê°€ ë³‘í•©</option>
                    <option value="overwrite">ê¸°ì¡´ ë°ì´í„° ì‚­ì œ í›„ ìƒˆë¡œ êµ¬ì„±</option>
                </select>
                <button onclick="runAnalyze()" class="btn btn-primary text-sm">ğŸ” ì´ë²¤íŠ¸ ë¶„ì„ ì‹¤í–‰</button>
                <span id="migAnalyzeStatus" class="text-xs text-gray-400"></span>
            </div>
            <div class="flex flex-1 overflow-hidden">
                <!-- ì¢Œ: ì´ë²¤íŠ¸ ëª©ë¡ -->
                <div class="w-96 border-r bg-gray-50 flex flex-col">
                    <div class="px-3 py-2 border-b text-xs text-gray-500 font-medium">ì´ë²¤íŠ¸ ëª©ë¡</div>
                    <div id="migEventList" class="flex-1 overflow-y-auto p-2 space-y-1">
                        <div class="text-center text-gray-400 text-sm py-8">ë¶„ì„ì„ ì‹¤í–‰í•˜ì„¸ìš”</div>
                    </div>
                </div>
                <!-- ìš°: í•„ë“œ ì„¤ì • -->
                <div class="flex-1 flex flex-col overflow-hidden">
                    <div id="migFieldArea" class="flex-1 overflow-y-auto p-5">
                        <div class="text-gray-400 text-center mt-20">â† ë¶„ì„ ì‹¤í–‰ í›„ ì´ë²¤íŠ¸ë¥¼ ì„ íƒí•˜ì„¸ìš”</div>
                    </div>
                    <div class="border-t px-5 py-3 flex justify-between bg-gray-50">
                        <button onclick="resetMigration()" class="btn text-sm" style="background:#ef4444;color:white;border:none">ğŸ—‘ ì´ˆê¸°í™”</button>
                        <button onclick="saveMigration()" class="btn btn-primary text-sm">ğŸ’¾ ë©”íƒ€ë°ì´í„° ì €ì¥</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- UML ë£° ë¹Œë” ëª¨ë‹¬ -->
    <div id="builderModal" class="modal">
        <div class="modal-content" style="width:95vw;max-width:1400px;height:90vh;display:flex;flex-direction:column;padding:0;">
            <div class="flex items-center justify-between px-5 py-3 border-b bg-slate-50">
                <div class="flex items-center gap-4">
                    <h3 class="text-lg font-semibold">ğŸ”§ ê·œì¹™ ë¹Œë”</h3>
                    <select id="builderRuleType" class="form-input text-sm" style="width:160px" oninput="updateBuilderUI()">
                        <option value="cep">CEP (ì‹¤ì‹œê°„ ì•Œë¦¼)</option>
                    </select>
                    <input type="text" id="builderRuleName" class="form-input" style="width:280px" placeholder="ê·œì¹™ ì´ë¦„">
                </div>
                <div class="flex items-center gap-2">
                    <button onclick="clearCanvas()" class="btn btn-secondary text-sm">ì´ˆê¸°í™”</button>
                    <button onclick="testRule()" class="btn btn-secondary text-sm">í…ŒìŠ¤íŠ¸</button>
                    <button onclick="saveRule()" class="btn btn-primary text-sm">ì €ì¥</button>
                    <button onclick="closeBuilder()" class="btn btn-secondary text-sm">ë‹«ê¸°</button>
                </div>
            </div>
            <div class="flex flex-1 overflow-hidden">
                <!-- ë…¸ë“œ íŒ”ë ˆíŠ¸ -->
                <div class="w-48 bg-gray-50 border-r p-3 overflow-y-auto">
                    <div class="text-xs font-semibold text-gray-500 mb-2">ë…¸ë“œ</div>
                    <div class="space-y-2">
                        <div class="palette-node" draggable="true" data-type="event">
                            <span class="text-lg">ğŸ“¥</span>
                            <span>ì´ë²¤íŠ¸</span>
                        </div>
                        <div class="palette-node" draggable="true" data-type="action">
                            <span class="text-lg">ğŸ””</span>
                            <span>ì•¡ì…˜</span>
                        </div>
                    </div>
                    <div class="text-xs text-gray-500 mt-4 p-2 bg-white rounded border">
                        <div class="font-semibold mb-1">ì‚¬ìš©ë²•</div>
                        <div>1. ë…¸ë“œ ë“œë˜ê·¸í•´ì„œ ë°°ì¹˜</div>
                        <div>2. â— ì  ë“œë˜ê·¸ë¡œ ì—°ê²°</div>
                        <div>3. ì—°ê²°ì„  í´ë¦­ â†’ ì‹œê°„ ì„¤ì •</div>
                        <div>4. ë…¸ë“œ í´ë¦­ â†’ ì†ì„± í¸ì§‘</div>
                    </div>
                </div>
                
                <!-- ìº”ë²„ìŠ¤ -->
                <div class="flex-1 relative bg-white" style="background-image: radial-gradient(circle, #ddd 1px, transparent 1px); background-size: 20px 20px;">
                    <div id="canvas" class="absolute inset-0 overflow-auto">
                        <svg id="canvasSvg" width="100%" height="100%" style="position:absolute;pointer-events:none;"></svg>
                        <div id="nodesContainer" style="position:relative;width:2000px;height:1500px;"></div>
                    </div>
                </div>
                
                <!-- ì†ì„± íŒ¨ë„ -->
                <div id="propsPanel" class="w-72 bg-gray-50 border-l p-4 overflow-y-auto">
                    <div class="text-xs font-semibold text-gray-500 mb-3">ì†ì„±</div>
                    <div id="propsContent" class="text-sm text-gray-400">ë…¸ë“œë¥¼ ì„ íƒí•˜ì„¸ìš”</div>
                </div>
            </div>
            <!-- ìƒì„±ëœ SQL ë¯¸ë¦¬ë³´ê¸° -->
            <div class="border-t bg-slate-900 text-green-400 p-3 font-mono text-xs" style="max-height:120px;overflow:auto;">
                <div class="text-gray-500 mb-1">-- Generated Flink SQL</div>
                <pre id="sqlPreview">SELECT * FROM events WHERE ...</pre>
            </div>
        </div>
    </div>

    <!-- ê·œì¹™ ìˆ˜ì • ëª¨ë‹¬ -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <h3 class="text-lg font-semibold mb-4" id="modalTitle">ê·œì¹™ ìˆ˜ì •</h3>
            <form id="editForm">
                <input type="hidden" id="editRuleId">
                <input type="hidden" id="editRuleType">
                
                <div class="form-group">
                    <label class="form-label">ê·œì¹™ JSON</label>
                    <textarea id="editJson" class="form-input" rows="18" style="font-family:monospace;font-size:12px;white-space:pre;tab-size:2"></textarea>
                    <p class="form-hint">JSONì„ ì§ì ‘ ìˆ˜ì • í›„ ì €ì¥í•˜ë©´ CEP/UEBAì— ë°˜ì˜ë©ë‹ˆë‹¤.</p>
                </div>
                
                <div class="form-group">
                    <label class="form-label flex items-center gap-2">
                        <input type="checkbox" id="editEnabled" checked>
                        <span>ê·œì¹™ í™œì„±í™”</span>
                    </label>
                </div>
                
                <div class="flex justify-end gap-3 mt-6">
                    <button type="button" class="btn btn-secondary" onclick="closeModal()">ì·¨ì†Œ</button>
                    <button type="submit" class="btn btn-primary">ì €ì¥</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        let rulesData = {};
        const categoryNames = {
            'media_control': 'ë§¤ì²´ ì œì–´', 'output_security': 'ì¶œë ¥ ë³´ì•ˆ', 'screen_security': 'í™”ë©´ ë³´ì•ˆ',
            'system_access': 'ì‹œìŠ¤í…œ/ì ‘ê·¼', 'agent': 'ì—ì´ì „íŠ¸', 'network': 'ë„¤íŠ¸ì›Œí¬',
            'process': 'í”„ë¡œì„¸ìŠ¤', 'security': 'ë³´ì•ˆ', 'auth': 'ì¸ì¦', 'device': 'ì¥ì¹˜', 'output': 'ì¶œë ¥', 'system': 'ì‹œìŠ¤í…œ'
        };
        
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', function() {
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                this.classList.add('active');
                document.getElementById('cep-panel').classList.toggle('hidden', this.dataset.tab !== 'cep');
                document.getElementById('ueba-panel').classList.toggle('hidden', this.dataset.tab !== 'ueba');
            });
        });

        // ê·œì¹™ ë¡œë“œ
        fetch('/api/cep/rules').then(r => r.json()).then(data => {
            const rules = data.rules || data;
            rulesData = {};
            rules.forEach(r => { r.id = r.id || r.ruleId; rulesData[r.id] = r; });
            
            document.getElementById('cepCount').textContent = `(${rules.length})`;
            
            // CEP í…Œì´ë¸”
            const cepBody = document.querySelector('#cepTable tbody');
            cepBody.innerHTML = '';
            rules.sort((a,b) => (a.name||'').localeCompare(b.name||'')).forEach(r => {
                const sev = r.cep?.severity || r.severity || 'MEDIUM';
                const badge = sev === 'CRITICAL' ? 'badge-critical' : sev === 'HIGH' ? 'badge-high' : sev === 'MEDIUM' ? 'badge-medium' : 'badge-low';
                const enabled = r.enabled !== false;
                const enabledBadge = enabled ? '<span class="badge" style="background:#dcfce7;color:#166534">ON</span>' : '<span class="badge" style="background:#fee2e2;color:#991b1b">OFF</span>';
                
                // íƒì§€ì¡°ê±´ íŒŒì‹±: conditions ë˜ëŠ” patternsì—ì„œ ì¶”ì¶œ
                let condText = r.description || '';
                if (!condText || condText === r.name) {
                    const conds = r.conditions || r.patterns?.[0]?.match?.conditions || [];
                    const msgId = r.patterns?.[0]?.match?.msgId || '';
                    const parts = [];
                    if (msgId) parts.push(msgId.replace('MESSAGE_',''));
                    conds.forEach(c => {
                        if (c.field === 'msgId') { if (!msgId) parts.push(String(c.value).replace('MESSAGE_','')); }
                        else if (c.op === 'time_range') parts.push(c.start + ':00~' + c.end + ':00');
                        else if (c.op === 'gte') parts.push(c.field + 'â‰¥' + formatValue(c.value));
                        else if (c.op === 'in') parts.push(c.field + ' in [' + (Array.isArray(c.value)?c.value.join(','):c.value) + ']');
                        else parts.push(c.field + ' ' + c.op + ' ' + c.value);
                    });
                    if (r.aggregate?.count?.min) parts.push(r.aggregate.count.min + 'íšŒâ†‘');
                    if (r.patterns?.length > 1) parts.push(r.patterns.length + 'ë‹¨ê³„ ìˆœì°¨');
                    condText = parts.join(' Â· ') || '-';
                }
                
                cepBody.innerHTML += `<tr class="editable" data-rule-id="${r.id}" style="${enabled?'':'opacity:0.5'}">
                    <td class="font-medium">${r.name}</td>
                    <td class="text-center">${enabledBadge}</td>
                    <td><span class="badge ${badge}">${sev}</span></td>
                    <td class="text-gray-500 text-sm">${categoryNames[r.category] || r.category || '-'}</td>
                    <td class="text-gray-600 text-sm" style="max-width:400px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap" title="${condText}">${condText}</td>
                </tr>`;
            });
            
            // í´ë¦­ ì´ë²¤íŠ¸
            document.querySelectorAll('tr.editable').forEach(row => {
                row.addEventListener('click', () => openEditModal(row.dataset.ruleId));
            });
        });
        
        function formatConditions(conditions) {
            return conditions.map(c => {
                if (c.op === 'time_range') return `${c.start}:00~${c.end}:00`;
                if (c.op === 'gte') return `${c.field}â‰¥${formatValue(c.value)}`;
                if (c.op === 'gt') return `${c.field}>${formatValue(c.value)}`;
                if (c.op === 'eq') return `${c.field}=${c.value}`;
                if (c.op === 'in') return `${c.field} in [${Array.isArray(c.value) ? c.value.join(',') : c.value}]`;
                return `${c.field} ${c.op} ${c.value}`;
            }).join(', ');
        }
        
        function formatValue(v) {
            if (typeof v !== 'number') return v;
            if (v >= 1048576) return Math.round(v / 1048576) + 'MB';
            if (v >= 1024) return Math.round(v / 1024) + 'KB';
            return v;
        }
        
        function openEditModal(ruleId) {
            const rule = rulesData[ruleId];
            if (!rule) return;
            
            const isCep = rule.cep?.enabled;
            const isUeba = rule.ueba?.enabled;
            
            document.getElementById('modalTitle').textContent = isCep ? 'CEP ê·œì¹™ ìˆ˜ì •' : 'UEBA ê·œì¹™ ìˆ˜ì •';
            document.getElementById('editRuleId').value = ruleId;
            document.getElementById('editRuleType').value = isCep ? 'cep' : 'ueba';
            document.getElementById('editName').value = rule.name;
            document.getElementById('editEnabled').checked = rule.enabled;
            
            // JSON í‘œì‹œ (ê°œë³„ í•„ë“œ ì—†ìŒ)
            // ì¡°ê±´ í•„ë“œ â€” ë¯¸ì‚¬ìš© (JSON ì§ì ‘ í¸ì§‘)
            const condFields_unused = null;
            if (false) (rule.match?.conditions || []).forEach((cond, idx) => {
                if (cond.op === 'gte' || cond.op === 'gt') {
                    const isMB = typeof cond.value === 'number' && cond.value >= 1048576;
                    const displayVal = isMB ? Math.round(cond.value / 1048576) : cond.value;
                    const label = cond.field === 'fileSize' ? 'íŒŒì¼ í¬ê¸°' : cond.field === 'pageCount' ? 'í˜ì´ì§€ ìˆ˜' : cond.field;
                    condFields.innerHTML += `
                        <div class="form-group">
                            <label class="form-label">${label} (${cond.op === 'gte' ? 'ì´ìƒ' : 'ì´ˆê³¼'})</label>
                            <div class="flex gap-2">
                                <input type="number" class="form-input cond-value" data-idx="${idx}" data-unit="${isMB ? 'MB' : ''}" value="${displayVal}" min="1">
                                ${isMB ? '<span class="flex items-center text-gray-500">MB</span>' : ''}
                            </div>
                        </div>`;
                } else if (cond.op === 'time_range') {
                    condFields.innerHTML += `
                        <div class="form-group">
                            <label class="form-label">ì‹œê°„ ë²”ìœ„</label>
                            <div class="flex gap-2 items-center">
                                <input type="number" class="form-input w-20 cond-start" data-idx="${idx}" value="${cond.start}" min="0" max="23">
                                <span>ì‹œ ~</span>
                                <input type="number" class="form-input w-20 cond-end" data-idx="${idx}" value="${cond.end}" min="0" max="23">
                                <span>ì‹œ</span>
                            </div>
                        </div>`;
                }
            });
            
            // JSON í¸ì§‘ ì˜ì—­ì— ì›ë³¸ ë°ì´í„° í‘œì‹œ (sql ì œì™¸)
            const jsonData = JSON.parse(JSON.stringify(rule));
            delete jsonData.sql;  // SQLì€ Go CEP ì„œë¹„ìŠ¤ê°€ ìë™ ìƒì„±
            document.getElementById('editJson').value = JSON.stringify(jsonData, null, 2);
            
            document.getElementById('editModal').classList.add('show');
        }
        
        function closeModal() {
            document.getElementById('editModal').classList.remove('show');
        }
        

        document.getElementById('editForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const ruleId = document.getElementById('editRuleId').value;
            
            // enabled ì²´í¬ë°•ìŠ¤ â†’ JSON ë°˜ì˜
            try {
                const j = JSON.parse(document.getElementById('editJson').value);
                j.enabled = document.getElementById('editEnabled').checked;
                document.getElementById('editJson').value = JSON.stringify(j, null, 2);
            } catch(e) {}
            
            let saveData;
            try {
                saveData = JSON.parse(document.getElementById('editJson').value);
            } catch(e) {
                alert('JSON í˜•ì‹ ì˜¤ë¥˜: ' + e.message);
                return;
            }
            
            const res = await fetch(`/api/cep/rules/${ruleId}`, {
                method: 'PUT',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(saveData)
            });
            
            if (res.ok) {
                alert('ê·œì¹™ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
                closeModal();
                location.reload();
            } else {
                alert('ì €ì¥ ì‹¤íŒ¨');
            }
        });
        
        document.getElementById('editModal').addEventListener('click', (e) => {
            if (e.target.id === 'editModal') closeModal();
        });

        // ========== UML Rule Builder ==========
        const eventTypes = [
            {
                id: 'MESSAGE_AGENT_AUTHENTICATION', name: 'ì‚¬ìš©ì ì¸ì¦', category: 'agent',
                fields: [
                    {id: 'act', name: 'ë™ì‘', type: 'enum', values: [
                        {v: 'login', label: 'ë¡œê·¸ì¸'}, {v: 'logout', label: 'ë¡œê·¸ì•„ì›ƒ'}
                    ]},
                    {id: 'outcome', name: 'ê²°ê³¼', type: 'enum', values: [
                        {v: 'success', label: 'ì„±ê³µ'}, {v: 'failure', label: 'ì‹¤íŒ¨'}
                    ]}
                ]
            },
            {
                id: 'MESSAGE_DEVICE_USAGE', name: 'ì¥ì¹˜ ì‚¬ìš©', category: 'device',
                fields: [
                    {id: 'act', name: 'ë™ì‘', type: 'enum', values: [
                        {v: 'connect', label: 'ì—°ê²°'}, {v: 'read', label: 'ì½ê¸°'}, {v: 'write', label: 'ì“°ê¸°'}
                    ]},
                    {id: 'outcome', name: 'ê²°ê³¼', type: 'enum', values: [
                        {v: 'allowed', label: 'í—ˆìš©'}, {v: 'blocked', label: 'ì°¨ë‹¨'}
                    ]},
                    {id: 'cs1', name: 'ì¥ì¹˜ íƒ€ì…', type: 'enum', values: [
                        {v: 'removable', label: 'USB'}, {v: 'bluetooth', label: 'ë¸”ë£¨íˆ¬ìŠ¤'}, {v: 'cdrom', label: 'CD/DVD'}, {v: 'mtp', label: 'MTP'}
                    ]},
                    {id: 'fsize', name: 'íŒŒì¼ í¬ê¸°', type: 'number', unit: 'MB'}
                ]
            },
            {
                id: 'MESSAGE_NETWORK_WEBSITEACCESS', name: 'ì›¹ì‚¬ì´íŠ¸ ì ‘ê·¼', category: 'network',
                fields: [
                    {id: 'act', name: 'ë™ì‘', type: 'enum', values: [
                        {v: 'navigate', label: 'ì ‘ì†'}, {v: 'file_attachment', label: 'íŒŒì¼ ì—…ë¡œë“œ'}, {v: 'content', label: 'ë‚´ìš© ì „ì†¡'}
                    ]},
                    {id: 'outcome', name: 'ê²°ê³¼', type: 'enum', values: [
                        {v: 'allowed', label: 'í—ˆìš©'}, {v: 'blocked', label: 'ì°¨ë‹¨'}
                    ]},
                    {id: 'dhost', name: 'ì‚¬ì´íŠ¸ ì£¼ì†Œ', type: 'string'},
                    {id: 'fsize', name: 'íŒŒì¼ í¬ê¸°', type: 'number', unit: 'MB'}
                ]
            },
            {
                id: 'MESSAGE_NETWORK_MESSENGERACTIVITY', name: 'ë©”ì‹ ì € í™œë™', category: 'network',
                fields: [
                    {id: 'act', name: 'ë™ì‘', type: 'enum', values: [
                        {v: 'file_attachment', label: 'íŒŒì¼ ì „ì†¡'}, {v: 'content', label: 'ë‚´ìš© ì „ì†¡'}, {v: 'clipboard', label: 'í´ë¦½ë³´ë“œ'}
                    ]},
                    {id: 'outcome', name: 'ê²°ê³¼', type: 'enum', values: [
                        {v: 'allowed', label: 'í—ˆìš©'}, {v: 'blocked', label: 'ì°¨ë‹¨'}
                    ]},
                    {id: 'app', name: 'ë©”ì‹ ì €', type: 'string'},
                    {id: 'fsize', name: 'íŒŒì¼ í¬ê¸°', type: 'number', unit: 'MB'}
                ]
            },
            {
                id: 'MESSAGE_PRINT_USAGE', name: 'í”„ë¦°íŠ¸ ì‚¬ìš©', category: 'print',
                fields: [
                    {id: 'outcome', name: 'ê²°ê³¼', type: 'enum', values: [
                        {v: 'allowed', label: 'í—ˆìš©'}, {v: 'blocked', label: 'ì°¨ë‹¨'}
                    ]},
                    {id: 'cn4', name: 'í˜ì´ì§€ ìˆ˜', type: 'number', unit: 'ì¥'},
                    {id: 'cs1', name: 'í”„ë¦°í„°ëª…', type: 'string'}
                ]
            },
            {
                id: 'MESSAGE_PROCESS_CONTROL', name: 'í”„ë¡œê·¸ë¨ ì‹¤í–‰', category: 'process',
                fields: [
                    {id: 'outcome', name: 'ê²°ê³¼', type: 'enum', values: [
                        {v: 'allowed', label: 'í—ˆìš©'}, {v: 'blocked', label: 'ì°¨ë‹¨'}
                    ]},
                    {id: 'reason', name: 'ì‚¬ìœ ', type: 'enum', values: [
                        {v: 'blacklist', label: 'ë¸”ë™ë¦¬ìŠ¤íŠ¸'}, {v: 'whitelist', label: 'í™”ì´íŠ¸ë¦¬ìŠ¤íŠ¸'}, {v: 'unregistered', label: 'ë¯¸ë“±ë¡'}
                    ]},
                    {id: 'fname', name: 'í”„ë¡œê·¸ë¨ëª…', type: 'string'}
                ]
            },
            {
                id: 'MESSAGE_CAPTURE_BLOCK', name: 'ìº¡ì²˜ ì°¨ë‹¨', category: 'security',
                fields: [
                    {id: 'outcome', name: 'ê²°ê³¼', type: 'enum', values: [
                        {v: 'allowed', label: 'í—ˆìš©'}, {v: 'blocked', label: 'ì°¨ë‹¨'}
                    ]},
                    {id: 'fname', name: 'í”„ë¡œê·¸ë¨ëª…', type: 'string'}
                ]
            },
            {
                id: 'MESSAGE_CLIPBOARD_BLOCK', name: 'í´ë¦½ë³´ë“œ ì°¨ë‹¨', category: 'security',
                fields: [
                    {id: 'cs1', name: 'ë‚´ìš© íƒ€ì…', type: 'enum', values: [
                        {v: 'text', label: 'í…ìŠ¤íŠ¸'}, {v: 'file', label: 'íŒŒì¼'}, {v: 'image', label: 'ì´ë¯¸ì§€'}
                    ]}
                ]
            },
            {
                id: 'MESSAGE_AGENT_UNINSTALL', name: 'ì—ì´ì „íŠ¸ ì‚­ì œ', category: 'agent',
                fields: [
                    {id: 'act', name: 'ì‚­ì œ ë°©ì‹', type: 'enum', values: [
                        {v: 'online_uninstall', label: 'ì˜¨ë¼ì¸ ì‚­ì œ'}, {v: 'offline_uninstall', label: 'ì˜¤í”„ë¼ì¸ ì‚­ì œ'}
                    ]}
                ]
            },
            {
                id: 'MESSAGE_SCREENBLOCKER_EVENT', name: 'ë¶ˆë²•ì´¬ì˜ ê°ì§€', category: 'security',
                fields: [
                    {id: 'eventType', name: 'ì´ë²¤íŠ¸ ì¢…ë¥˜', type: 'enum', values: [
                        {v: 'photo', label: 'ì´¬ì˜ ê°ì§€'}, {v: 'facelost', label: 'ìë¦¬ ì´íƒˆ'}, {v: 'webcamblock', label: 'ì›¹ìº  ê°€ë¦¼'}
                    ]},
                    {id: 'blockType', name: 'ì°¨ë‹¨ ë™ì‘', type: 'enum', values: [
                        {v: 'screen_saver', label: 'í™”ë©´ë³´í˜¸ê¸°'}, {v: 'logoff', label: 'ë¡œê·¸ì˜¤í”„'}, {v: 'visible_watermark', label: 'ì›Œí„°ë§ˆí¬'}
                    ]}
                ]
            }
        ];
        
        // í•„ë“œ ë§¤í•‘: CEF â†’ OpenSearch
        const fieldMap = {
            'msgid': 'msgId',
            'suid': 'userId',
            'act': 'action',
            'rt': '@timestamp',
            'src': 'userIp',
            'shost': 'hostname',
            'fsize': 'fileSize',
            'fname': 'fileName',
            'dhost': 'destHost',
            'cs1': 'deviceType',
            'cn4': 'pageCount'
        };
        
        function mapField(field) {
            return fieldMap[field] || field;
        }
        
        function parseWindow(w) {
            if (!w) return {val: 0, unit: 'MINUTE'};
            const num = parseInt(w.replace(/[^0-9]/g, '')) || 10;
            const unit = w.toLowerCase().includes('h') ? 'HOUR' : 'MINUTE';
            return {val: num, unit};
        }
        
        let nodes = [];
        let edges = [];
        let selectedNode = null;
        let nodeIdCounter = 1;
        let dragNode = null;
        let dragOffset = {x: 0, y: 0};
        let connecting = null;
        
        function openRuleBuilder() {
            document.getElementById('builderModal').classList.add('show');
            document.getElementById('builderRuleName').value = '';
            clearCanvas();
        }
        
        function closeBuilder() {
            document.getElementById('builderModal').classList.remove('show');
        }
        
        function clearCanvas() {
            nodes = [];
            edges = [];
            selectedNode = null;
            nodeIdCounter = 1;
            renderCanvas();
            updateSqlPreview();
            document.getElementById('propsContent').innerHTML = '<span class="text-gray-400">ë…¸ë“œë¥¼ ì„ íƒí•˜ì„¸ìš”</span>';
        }
        
        // íŒ”ë ˆíŠ¸ ë“œë˜ê·¸
        document.querySelectorAll('.palette-node').forEach(el => {
            el.addEventListener('dragstart', (e) => {
                e.dataTransfer.setData('nodeType', el.dataset.type);
            });
        });
        
        document.getElementById('nodesContainer').addEventListener('dragover', (e) => e.preventDefault());
        document.getElementById('nodesContainer').addEventListener('drop', (e) => {
            e.preventDefault();
            const type = e.dataTransfer.getData('nodeType');
            if (!type) return;
            
            const rect = e.currentTarget.getBoundingClientRect();
            const scrollLeft = document.getElementById('canvas').scrollLeft;
            const scrollTop = document.getElementById('canvas').scrollTop;
            const x = e.clientX - rect.left + scrollLeft - 80;
            const y = e.clientY - rect.top + scrollTop - 30;
            
            addNode(type, x, y);
        });
        
        function addNode(type, x, y) {
            const id = 'n' + nodeIdCounter++;
            const node = {id, type, x, y, data: getDefaultData(type)};
            nodes.push(node);
            renderCanvas();
            selectNode(id);
            updateSqlPreview();
        }
        
        function getDefaultData(type) {
            switch(type) {
                case 'event': return {msgId: 'MESSAGE_AGENT_AUTHENTICATION', conditions: [], window: null, count: 1};
                case 'action': return {severity: 'HIGH', score: 15, message: 'ì´ìƒ í–‰ìœ„ íƒì§€'};
            }
        }
        
        function renderCanvas() {
            const container = document.getElementById('nodesContainer');
            container.innerHTML = '';
            
            nodes.forEach(node => {
                const el = document.createElement('div');
                el.className = `canvas-node ${node.type}`;
                el.id = node.id;
                el.style.left = node.x + 'px';
                el.style.top = node.y + 'px';
                if (selectedNode === node.id) el.classList.add('selected');
                
                el.innerHTML = `
                    <div class="node-delete" onclick="deleteNode('${node.id}')">Ã—</div>
                    <div class="node-port in" data-node="${node.id}" data-port="in"></div>
                    <div class="node-port out" data-node="${node.id}" data-port="out"></div>
                    <div class="node-header">${getNodeIcon(node.type)} ${getNodeTitle(node)}</div>
                    <div class="node-body">${getNodeBody(node)}</div>
                `;
                
                el.addEventListener('mousedown', (e) => {
                    if (e.target.classList.contains('node-port') || e.target.classList.contains('node-delete')) return;
                    e.preventDefault();
                    selectNode(node.id);
                    dragNode = node;
                    dragOffset = {x: e.clientX - node.x, y: e.clientY - node.y};
                });
                
                // í¬íŠ¸ ì—°ê²° ì´ë²¤íŠ¸
                const outPort = el.querySelector('.node-port.out');
                
                outPort.addEventListener('mousedown', (e) => {
                    e.stopPropagation();
                    e.preventDefault();
                    connecting = {
                        from: node.id,
                        startX: node.x + el.offsetWidth,
                        startY: node.y + el.offsetHeight / 2
                    };
                    // ì—°ê²°ì„  ë¯¸ë¦¬ë³´ê¸°
                    const svg = document.getElementById('canvasSvg');
                    const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                    line.id = 'tempLine';
                    line.setAttribute('stroke', '#3b82f6');
                    line.setAttribute('stroke-width', '2');
                    line.setAttribute('stroke-dasharray', '5,5');
                    line.setAttribute('x1', connecting.startX);
                    line.setAttribute('y1', connecting.startY);
                    line.setAttribute('x2', connecting.startX);
                    line.setAttribute('y2', connecting.startY);
                    svg.appendChild(line);
                });
                
                // ë…¸ë“œ ì „ì²´ì—ì„œ ì—°ê²° ë°›ê¸°
                el.addEventListener('mouseup', (e) => {
                    if (connecting && connecting.from !== node.id) {
                        const exists = edges.some(ed => ed.from === connecting.from && ed.to === node.id);
                        if (!exists) {
                            edges.push({from: connecting.from, to: node.id});
                            connecting = null;
                            const tempLine = document.getElementById('tempLine');
                            if (tempLine) tempLine.remove();
                            renderEdges();
                            updateSqlPreview();
                        }
                    }
                });
                
                container.appendChild(el);
            });
            
            renderEdges();
        }
        
        function renderEdges() {
            const svg = document.getElementById('canvasSvg');
            const container = document.getElementById('nodesContainer');
            svg.innerHTML = '';
            svg.style.width = container.style.width;
            svg.style.height = container.style.height;
            
            // í™”ì‚´í‘œ ë§ˆì»¤
            const defs = document.createElementNS('http://www.w3.org/2000/svg', 'defs');
            defs.innerHTML = `<marker id="arrowhead" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto"><polygon points="0 0, 10 3.5, 0 7" fill="#3b82f6"/></marker>`;
            svg.appendChild(defs);
            
            edges.forEach((edge, idx) => {
                const fromNode = nodes.find(n => n.id === edge.from);
                const toNode = nodes.find(n => n.id === edge.to);
                if (!fromNode || !toNode) return;
                
                const fromEl = document.getElementById(fromNode.id);
                const toEl = document.getElementById(toNode.id);
                if (!fromEl || !toEl) return;
                
                const x1 = fromNode.x + fromEl.offsetWidth;
                const y1 = fromNode.y + fromEl.offsetHeight / 2;
                const x2 = toNode.x;
                const y2 = toNode.y + toEl.offsetHeight / 2;
                
                const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                const midX = (x1 + x2) / 2;
                path.setAttribute('d', `M${x1},${y1} C${midX},${y1} ${midX},${y2} ${x2},${y2}`);
                path.setAttribute('stroke', '#3b82f6');
                path.setAttribute('stroke-width', '2');
                path.setAttribute('fill', 'none');
                path.setAttribute('marker-end', 'url(#arrowhead)');
                path.style.cursor = 'pointer';
                path.addEventListener('click', () => showEdgeProps(idx));
                svg.appendChild(path);
                
                // ì‹œê°„ ë¼ë²¨
                if (edge.within) {
                    const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                    text.setAttribute('x', midX);
                    text.setAttribute('y', (y1 + y2) / 2 - 8);
                    text.setAttribute('text-anchor', 'middle');
                    text.setAttribute('fill', '#3b82f6');
                    text.setAttribute('font-size', '12');
                    text.setAttribute('font-weight', '600');
                    text.style.cursor = 'pointer';
                    text.textContent = edge.within + ' ë‚´';
                    text.addEventListener('click', () => showEdgeProps(idx));
                    svg.appendChild(text);
                }
            });
        }
        
        function showEdgeProps(idx) {
            const edge = edges[idx];
            const within = prompt('ì‹œê°„ ê°„ê²© (ì˜ˆ: 10m, 1h, 30s):', edge.within || '10m');
            if (within !== null) {
                if (within === '' || within === '0') {
                    if (confirm('ì—°ê²°ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                        edges.splice(idx, 1);
                    }
                } else {
                    edge.within = within;
                }
                renderEdges();
                updateSqlPreview();
            }
        }
        
        document.addEventListener('mousemove', (e) => {
            if (dragNode) {
                dragNode.x = Math.max(0, e.clientX - dragOffset.x);
                dragNode.y = Math.max(0, e.clientY - dragOffset.y);
                renderCanvas();
            }
            // ì—°ê²°ì„  ë¯¸ë¦¬ë³´ê¸°
            if (connecting) {
                const line = document.getElementById('tempLine');
                if (line) {
                    const rect = document.getElementById('nodesContainer').getBoundingClientRect();
                    const canvas = document.getElementById('canvas');
                    const x = e.clientX - rect.left + canvas.scrollLeft;
                    const y = e.clientY - rect.top + canvas.scrollTop;
                    line.setAttribute('x2', x);
                    line.setAttribute('y2', y);
                }
            }
        });
        
        document.addEventListener('mouseup', () => {
            dragNode = null;
            connecting = null;
            const tempLine = document.getElementById('tempLine');
            if (tempLine) tempLine.remove();
        });
        
        function getNodeIcon(type) {
            return {event: 'ğŸ“¥', condition: 'â—‡', window: 'â±ï¸', action: 'ğŸ””'}[type];
        }
        
        function getNodeTitle(node) {
            switch(node.type) {
                case 'event': 
                    const ev = eventTypes.find(e => e.id === node.data.msgId);
                    return ev?.name || 'ì´ë²¤íŠ¸';
                case 'action': return node.data.severity;
            }
        }
        
        function getNodeBody(node) {
            switch(node.type) {
                case 'event':
                    let parts = [];
                    if (node.data.count > 1) {
                        parts.push(`${node.data.window || ''} ${node.data.count}íšŒ ì´ìƒ`);
                    }
                    node.data.conditions.forEach(c => {
                        const evType = eventTypes.find(e => e.id === node.data.msgId);
                        const field = evType?.fields.find(f => f.id === c.field);
                        if (field?.type === 'enum') {
                            const valLabel = field.values.find(v => v.v === c.value)?.label || c.value;
                            parts.push(`${c.label || field.name}: ${valLabel}`);
                        } else if (field?.type === 'number') {
                            const opLabel = c.op === '>' ? 'ì´ˆê³¼' : c.op === '>=' ? 'ì´ìƒ' : c.op === '<' ? 'ë¯¸ë§Œ' : c.op;
                            const dispVal = c.unit === 'MB' ? (c.value / 1048576) + 'MB' : c.value + (c.unit || '');
                            parts.push(`${c.label || field?.name}: ${dispVal} ${opLabel}`);
                        } else {
                            parts.push(`${c.label || c.field}: ${c.value}`);
                        }
                    });
                    return parts.length ? parts.join('<br>') : 'í´ë¦­í•˜ì—¬ ì„¤ì •';
                case 'action':
                    const ruleType = document.getElementById('builderRuleType')?.value || 'cep';
                    if (ruleType === 'cep') {
                        return node.data.severity;
                    } else {
                        return `ê°€ì¤‘ì¹˜: ${node.data.score}`;
                    }
            }
        }
        
        function updateBuilderUI() {
            const actionNode = nodes.find(n => n.type === 'action');
            if (actionNode) {
                showProps(actionNode);
            }
            renderCanvas();
        }
        
        function formatCondValue(v) {
            if (typeof v === 'number' && v >= 1048576) return Math.round(v/1048576) + 'MB';
            return v;
        }
        
        function selectNode(id) {
            selectedNode = id;
            renderCanvas();
            showProps(nodes.find(n => n.id === id));
        }
        
        function deleteNode(id) {
            nodes = nodes.filter(n => n.id !== id);
            edges = edges.filter(e => e.from !== id && e.to !== id);
            if (selectedNode === id) selectedNode = null;
            renderCanvas();
            updateSqlPreview();
            document.getElementById('propsContent').innerHTML = '<span class="text-gray-400">ë…¸ë“œë¥¼ ì„ íƒí•˜ì„¸ìš”</span>';
        }
        
        function showProps(node) {
            if (!node) return;
            const panel = document.getElementById('propsContent');
            const evType = eventTypes.find(e => e.id === node.data.msgId);
            const evFields = evType?.fields || [];
            
            let html = `<div class="space-y-3">`;
            
            if (node.type === 'event') {
                html += `
                    <div>
                        <label class="form-label">ì´ë²¤íŠ¸ ì¢…ë¥˜</label>
                        <select class="form-input text-sm" oninput="updateNodeData('${node.id}', 'msgId', this.value); showProps(nodes.find(n=>n.id==='${node.id}'))">
                            <optgroup label="ì¸ì¦/ì—ì´ì „íŠ¸">
                                ${eventTypes.filter(e=>e.category==='agent').map(e => `<option value="${e.id}" ${node.data.msgId === e.id ? 'selected' : ''}>${e.name}</option>`).join('')}
                            </optgroup>
                            <optgroup label="ì¥ì¹˜">
                                ${eventTypes.filter(e=>e.category==='device').map(e => `<option value="${e.id}" ${node.data.msgId === e.id ? 'selected' : ''}>${e.name}</option>`).join('')}
                            </optgroup>
                            <optgroup label="ë„¤íŠ¸ì›Œí¬">
                                ${eventTypes.filter(e=>e.category==='network').map(e => `<option value="${e.id}" ${node.data.msgId === e.id ? 'selected' : ''}>${e.name}</option>`).join('')}
                            </optgroup>
                            <optgroup label="ì¶œë ¥/í”„ë¡œì„¸ìŠ¤">
                                ${eventTypes.filter(e=>e.category==='print'||e.category==='process').map(e => `<option value="${e.id}" ${node.data.msgId === e.id ? 'selected' : ''}>${e.name}</option>`).join('')}
                            </optgroup>
                            <optgroup label="ë³´ì•ˆ">
                                ${eventTypes.filter(e=>e.category==='security').map(e => `<option value="${e.id}" ${node.data.msgId === e.id ? 'selected' : ''}>${e.name}</option>`).join('')}
                            </optgroup>
                        </select>
                    </div>
                    <div class="border-t pt-3">
                        <label class="form-label">ë°œìƒ íšŸìˆ˜</label>
                        <div class="flex gap-2 items-center">
                            <input type="number" class="form-input text-sm w-20" value="${node.data.count}" min="1" oninput="updateNodeData('${node.id}', 'count', parseInt(this.value))">
                            <span class="text-sm text-gray-500">íšŒ ì´ìƒ</span>
                        </div>
                    </div>
                    <div>
                        <label class="form-label">ì§‘ê³„ ì‹œê°„ (íšŸìˆ˜ ì¡°ê±´ìš©)</label>
                        <input type="text" class="form-input text-sm" value="${node.data.window || ''}" placeholder="ì˜ˆ: 10m, 1h" oninput="updateNodeData('${node.id}', 'window', this.value || null)">
                        <p class="text-xs text-gray-400 mt-1">ë¹„ì›Œë‘ë©´ ë‹¨ì¼ ì´ë²¤íŠ¸ ê°ì§€</p>
                    </div>`;
                
                // í•„ë“œë³„ ì¡°ê±´ ì¶”ê°€ UI
                if (evFields.length > 0) {
                    html += `<div class="border-t pt-3">
                        <label class="form-label">ì„¸ë¶€ ì¡°ê±´</label>
                        <div class="space-y-2 mb-2">`;
                    
                    evFields.forEach(field => {
                        const existing = node.data.conditions.find(c => c.field === field.id);
                        
                        if (field.type === 'enum') {
                            html += `<div class="flex items-center gap-2">
                                <span class="text-xs text-gray-600 w-20">${field.name}</span>
                                <select class="form-input text-xs flex-1" oninput="setCondition('${node.id}', '${field.id}', '=', this.value, '${field.name}')">
                                    <option value="">ì „ì²´</option>
                                    ${field.values.map(v => `<option value="${v.v}" ${existing?.value === v.v ? 'selected' : ''}>${v.label}</option>`).join('')}
                                </select>
                            </div>`;
                        } else if (field.type === 'number') {
                            html += `<div class="flex items-center gap-2">
                                <span class="text-xs text-gray-600 w-20">${field.name}</span>
                                <select class="form-input text-xs w-16" id="op_${field.id}" oninput="setNumCondition('${node.id}', '${field.id}', this.value, document.getElementById('val_${field.id}').value, '${field.name}', '${field.unit||''}')">
                                    <option value="">-</option>
                                    <option value=">" ${existing?.op === '>' ? 'selected' : ''}>ì´ˆê³¼</option>
                                    <option value=">=" ${existing?.op === '>=' ? 'selected' : ''}>ì´ìƒ</option>
                                    <option value="<" ${existing?.op === '<' ? 'selected' : ''}>ë¯¸ë§Œ</option>
                                </select>
                                <input type="number" class="form-input text-xs w-16" id="val_${field.id}" value="${existing ? (field.unit === 'MB' ? existing.value / 1048576 : existing.value) : ''}" placeholder="ê°’" oninput="setNumCondition('${node.id}', '${field.id}', document.getElementById('op_${field.id}').value, this.value, '${field.name}', '${field.unit||''}')">
                                <span class="text-xs text-gray-400">${field.unit || ''}</span>
                            </div>`;
                        } else if (field.type === 'string') {
                            html += `<div class="flex items-center gap-2">
                                <span class="text-xs text-gray-600 w-20">${field.name}</span>
                                <input type="text" class="form-input text-xs flex-1" value="${existing?.value || ''}" placeholder="í¬í•¨ ë¬¸ìì—´" oninput="setCondition('${node.id}', '${field.id}', 'contains', this.value, '${field.name}')">
                            </div>`;
                        }
                    });
                    
                    html += `</div></div>`;
                }
            } else if (node.type === 'action') {
                const ruleType = document.getElementById('builderRuleType').value;
                
                if (ruleType === 'cep') {
                    html += `
                        <div>
                            <label class="form-label">ì‹¬ê°ë„</label>
                            <select class="form-input text-sm" oninput="updateNodeData('${node.id}', 'severity', this.value)">
                                <option value="CRITICAL" ${node.data.severity === 'CRITICAL' ? 'selected' : ''}>ğŸ”´ ê¸´ê¸‰ (CRITICAL)</option>
                                <option value="HIGH" ${node.data.severity === 'HIGH' ? 'selected' : ''}>ğŸŸ  ë†’ìŒ (HIGH)</option>
                                <option value="MEDIUM" ${node.data.severity === 'MEDIUM' ? 'selected' : ''}>ğŸŸ¡ ë³´í†µ (MEDIUM)</option>
                                <option value="LOW" ${node.data.severity === 'LOW' ? 'selected' : ''}>ğŸŸ¢ ë‚®ìŒ (LOW)</option>
                            </select>
                        </div>
                        <div>
                            <label class="form-label">ì•Œë¦¼ ë©”ì‹œì§€</label>
                            <textarea class="form-input text-sm" rows="2" oninput="updateNodeData('${node.id}', 'message', this.value)">${node.data.message}</textarea>
                        </div>
                    `;
                } else {
                    html += `
                        <div>
                            <label class="form-label">ìœ„í—˜ë„ ê°€ì¤‘ì¹˜</label>
                            <input type="number" class="form-input text-sm" value="${node.data.score}" min="1" max="20" oninput="updateNodeData('${node.id}', 'score', parseInt(this.value))">
                            <p class="text-xs text-gray-400 mt-1">1~20 (ë†’ì„ìˆ˜ë¡ ìœ„í—˜ë„ ê¸°ì—¬ ì¦ê°€)</p>
                        </div>
                        <div>
                            <label class="form-label">ì„¤ëª…</label>
                            <textarea class="form-input text-sm" rows="2" oninput="updateNodeData('${node.id}', 'message', this.value)">${node.data.message}</textarea>
                        </div>
                    `;
                }
            }
            
            html += `</div>`;
            panel.innerHTML = html;
        }
        
        function setCondition(nodeId, field, op, value, label) {
            const node = nodes.find(n => n.id === nodeId);
            if (!node) return;
            
            // ê¸°ì¡´ ì¡°ê±´ ì œê±°
            node.data.conditions = node.data.conditions.filter(c => c.field !== field);
            
            // ê°’ì´ ìˆìœ¼ë©´ ì¶”ê°€
            if (value) {
                node.data.conditions.push({field, op, value, label});
            }
            renderCanvas();
            updateSqlPreview();
        }
        
        function setNumCondition(nodeId, field, op, value, label, unit) {
            const node = nodes.find(n => n.id === nodeId);
            if (!node) return;
            
            node.data.conditions = node.data.conditions.filter(c => c.field !== field);
            
            if (op && value) {
                let numVal = parseFloat(value);
                if (unit === 'MB') numVal *= 1048576;
                node.data.conditions.push({field, op, value: numVal, label, unit});
            }
            renderCanvas();
            updateSqlPreview();
        }
        
        function updateNodeData(nodeId, key, value) {
            const node = nodes.find(n => n.id === nodeId);
            if (node) {
                node.data[key] = value;
                if (key === 'msgId') node.data.conditions = []; // ì´ë²¤íŠ¸ ë³€ê²½ì‹œ ì¡°ê±´ ì´ˆê¸°í™”
                renderCanvas();
                showProps(node);
                updateSqlPreview();
            }
        }
        
        function updateSqlPreview() {
            const eventNodes = nodes.filter(n => n.type === 'event');
            const actionNode = nodes.find(n => n.type === 'action');
            
            if (eventNodes.length === 0) {
                document.getElementById('sqlPreview').textContent = '-- ì´ë²¤íŠ¸ ë…¸ë“œë¥¼ ì¶”ê°€í•˜ì„¸ìš”';
                return;
            }
            
            let sql = '';
            
            // ì—°ê²° ìˆœì„œëŒ€ë¡œ ì´ë²¤íŠ¸ ì •ë ¬
            const eventIds = eventNodes.map(n => n.id);
            const eventEdges = edges.filter(e => eventIds.includes(e.from) && eventIds.includes(e.to));
            
            // ì—°ê²°ëœ ìˆœì„œëŒ€ë¡œ ì •ë ¬
            let orderedEvents = [];
            if (eventEdges.length > 0) {
                // ì‹œì‘ì  ì°¾ê¸° (ë“¤ì–´ì˜¤ëŠ” edgeê°€ ì—†ëŠ” ë…¸ë“œ)
                const targets = new Set(eventEdges.map(e => e.to));
                let current = eventNodes.find(n => !targets.has(n.id));
                if (!current) current = eventNodes[0];
                
                orderedEvents.push(current);
                while (orderedEvents.length < eventNodes.length) {
                    const nextEdge = eventEdges.find(e => e.from === current.id);
                    if (!nextEdge) break;
                    const nextNode = eventNodes.find(n => n.id === nextEdge.to);
                    if (!nextNode || orderedEvents.includes(nextNode)) break;
                    orderedEvents.push(nextNode);
                    current = nextNode;
                }
            } else {
                orderedEvents = eventNodes;
            }
            
            const ts = mapField('rt');
            const uid = mapField('suid');
            
            if (eventNodes.length === 1) {
                const ev = eventNodes[0];
                const where = buildWhere(ev, '');
                
                if (ev.data.window && ev.data.count > 1) {
                    // ìœˆë„ìš° + íšŸìˆ˜ ì¡°ê±´
                    const w = parseWindow(ev.data.window);
                    sql = `SELECT ${uid}, COUNT(*) as cnt\nFROM events\nWHERE ${where.join(' AND ')}\nGROUP BY ${uid}, TUMBLE(${ts}, INTERVAL '${w.val}' ${w.unit})\nHAVING COUNT(*) >= ${ev.data.count}`;
                } else if (ev.data.window) {
                    // ìœˆë„ìš°ë§Œ (íšŸìˆ˜ 1 = í•´ë‹¹ ìœˆë„ìš° ë‚´ ë°œìƒ ì—¬ë¶€)
                    const w = parseWindow(ev.data.window);
                    sql = `SELECT ${uid}, COUNT(*) as cnt\nFROM events\nWHERE ${where.join(' AND ')}\nGROUP BY ${uid}, TUMBLE(${ts}, INTERVAL '${w.val}' ${w.unit})\nHAVING COUNT(*) >= 1`;
                } else {
                    sql = `SELECT * FROM events\nWHERE ${where.join('\n  AND ')}`;
                }
            } else if (orderedEvents.length >= 2 && eventEdges.length > 0) {
                // Nê°œ ì´ë²¤íŠ¸ ì‹œí€€ìŠ¤
                const hasCountCondition = orderedEvents.some(ev => ev.data.count > 1);
                
                if (hasCountCondition) {
                    // JOIN ë°©ì‹ (íšŸìˆ˜ ì¡°ê±´ ìˆì„ ë•Œ)
                    sql = buildJoinSql(orderedEvents, eventEdges);
                } else {
                    // MATCH_RECOGNIZE ë°©ì‹ (ë‹¨ìˆœ ì‹œí€€ìŠ¤)
                    sql = buildMatchRecognizeSql(orderedEvents, eventEdges);
                }
            } else if (eventNodes.length >= 2) {
                sql = `-- ì´ë²¤íŠ¸ ë…¸ë“œë“¤ì„ ì„œë¡œ ì—°ê²°í•˜ì„¸ìš” (${eventNodes.length}ê°œ ì´ë²¤íŠ¸)`;
            }
            
            if (actionNode) {
                sql += `\n\n-- Action: ${actionNode.data.severity}, UEBA +${actionNode.data.score}ì , "${actionNode.data.message}"`;
            }
            
            document.getElementById('sqlPreview').textContent = sql;
        }
        
        function buildWhere(ev, alias) {
            const prefix = alias ? alias + '.' : '';
            const where = [`${prefix}${mapField('msgid')} = '${ev.data.msgId}'`];
            ev.data.conditions.forEach(c => {
                const field = mapField(c.field);
                where.push(`${prefix}${field} ${c.op} ${typeof c.value === 'string' ? `'${c.value}'` : c.value}`);
            });
            return where;
        }
        
        function buildJoinSql(orderedEvents, eventEdges) {
            const aliases = orderedEvents.map((_, i) => String.fromCharCode(97 + i)); // a, b, c, ...
            const evNames = orderedEvents.map(ev => eventTypes.find(e => e.id === ev.data.msgId)?.name || ev.data.msgId);
            const ts = mapField('rt');
            const uid = mapField('suid');
            
            // ì£¼ì„
            let sql = `-- ì‹œí€€ìŠ¤: ${evNames.join(' â†’ ')}\n`;
            sql += `SELECT\n  ${aliases[0]}.${uid}`;
            
            orderedEvents.forEach((ev, i) => {
                sql += `,\n  ${aliases[i]}.${ts} AS event${i+1}_time`;
                if (ev.data.count > 1) {
                    sql += `,\n  COUNT(DISTINCT ${aliases[i]}.${ts}) AS event${i+1}_count`;
                }
            });
            
            sql += `\nFROM events ${aliases[0]}`;
            
            // JOIN ì ˆ
            for (let i = 1; i < orderedEvents.length; i++) {
                const edge = eventEdges.find(e => e.from === orderedEvents[i-1].id && e.to === orderedEvents[i].id);
                const w = parseWindow(edge?.within || '10m');
                
                sql += `\nJOIN events ${aliases[i]} ON ${aliases[0]}.${uid} = ${aliases[i]}.${uid}`;
                sql += `\n  AND ${aliases[i]}.${ts} > ${aliases[i-1]}.${ts}`;
                sql += `\n  AND ${aliases[i]}.${ts} <= ${aliases[i-1]}.${ts} + INTERVAL '${w.val}' ${w.unit}`;
            }
            
            // WHERE ì ˆ
            sql += `\nWHERE `;
            const whereClauses = [];
            orderedEvents.forEach((ev, i) => {
                whereClauses.push(...buildWhere(ev, aliases[i]));
            });
            sql += whereClauses.join('\n  AND ');
            
            // GROUP BY
            sql += `\nGROUP BY ${aliases[0]}.${uid}`;
            orderedEvents.forEach((ev, i) => {
                if (ev.data.count <= 1) {
                    sql += `, ${aliases[i]}.${ts}`;
                }
            });
            
            // HAVING (íšŸìˆ˜ ì¡°ê±´)
            const havingClauses = [];
            orderedEvents.forEach((ev, i) => {
                if (ev.data.count > 1) {
                    havingClauses.push(`COUNT(DISTINCT ${aliases[i]}.${ts}) >= ${ev.data.count}`);
                }
            });
            if (havingClauses.length > 0) {
                sql += `\nHAVING ${havingClauses.join(' AND ')}`;
            }
            
            return sql;
        }
        
        function buildMatchRecognizeSql(orderedEvents, eventEdges) {
            const edge = eventEdges[0];
            const w = parseWindow(edge?.within || '10m');
            const ts = mapField('rt');
            const uid = mapField('suid');
            
            let sql = `SELECT * FROM events\nMATCH_RECOGNIZE (\n  PARTITION BY ${uid}\n  ORDER BY ${ts}\n  MEASURES\n`;
            orderedEvents.forEach((ev, i) => {
                sql += `    ${String.fromCharCode(65+i)}.${ts} AS event${i+1}_time${i < orderedEvents.length-1 ? ',' : ''}\n`;
            });
            sql += `  PATTERN (${orderedEvents.map((_, i) => String.fromCharCode(65+i)).join(' ')}) WITHIN INTERVAL '${w.val}' ${w.unit}\n  DEFINE\n`;
            orderedEvents.forEach((ev, i) => {
                const conds = buildWhere(ev, String.fromCharCode(65+i));
                sql += `    ${String.fromCharCode(65+i)} AS ${conds.join(' AND ')}${i < orderedEvents.length-1 ? ',' : ''}\n`;
            });
            sql += `)`;
            return sql;
        }
        
        async function testRule() {
            const sql = document.getElementById('sqlPreview').textContent;
            
            if (sql.startsWith('--') && !sql.includes('SELECT')) {
                alert('âŒ ìœ íš¨í•˜ì§€ ì•ŠìŒ\n\nì´ë²¤íŠ¸ ë…¸ë“œë¥¼ ì¶”ê°€í•˜ê³  ì—°ê²°í•˜ì„¸ìš”.');
                return;
            }
            
            // ê¸°ë³¸ ë¬¸ë²• ì²´í¬
            const errors = [];
            
            if (!sql.includes('SELECT')) errors.push('SELECT ë¬¸ì´ ì—†ìŠµë‹ˆë‹¤');
            if (!sql.includes('FROM events')) errors.push('FROM eventsê°€ ì—†ìŠµë‹ˆë‹¤');
            if (sql.includes('MATCH_RECOGNIZE')) {
                if (!sql.includes('PARTITION BY')) errors.push('PARTITION BYê°€ ì—†ìŠµë‹ˆë‹¤');
                if (!sql.includes('PATTERN')) errors.push('PATTERNì´ ì—†ìŠµë‹ˆë‹¤');
                if (!sql.includes('DEFINE')) errors.push('DEFINEì´ ì—†ìŠµë‹ˆë‹¤');
            }
            if (sql.includes('JOIN') && !sql.includes('ON')) errors.push('JOINì— ON ì¡°ê±´ì´ ì—†ìŠµë‹ˆë‹¤');
            
            // ê´„í˜¸ ì§ ì²´í¬
            const openParen = (sql.match(/\(/g) || []).length;
            const closeParen = (sql.match(/\)/g) || []).length;
            if (openParen !== closeParen) errors.push(`ê´„í˜¸ ë¶ˆì¼ì¹˜: ( ${openParen}ê°œ, ) ${closeParen}ê°œ`);
            
            // NaN, undefined, null ì²´í¬
            if (sql.includes('NaN')) errors.push('ì˜ëª»ëœ ìˆ«ìê°’ (NaN) - ì§‘ê³„ ì‹œê°„ì„ í™•ì¸í•˜ì„¸ìš”');
            if (sql.includes('undefined')) errors.push('ì •ì˜ë˜ì§€ ì•Šì€ ê°’ (undefined)');
            if (sql.includes("'null'") || sql.match(/= null[^a-z]/)) errors.push('null ê°’ì´ í¬í•¨ë¨');
            
            // INTERVAL ê°’ ì²´í¬
            const intervalMatch = sql.match(/INTERVAL '(\d+)'/g);
            if (intervalMatch) {
                intervalMatch.forEach(m => {
                    const val = parseInt(m.match(/\d+/)[0]);
                    if (val <= 0 || val > 1440) errors.push(`ì˜ëª»ëœ ì‹œê°„ ê°„ê²©: ${m}`);
                });
            }
            
            if (errors.length > 0) {
                alert('âŒ ë¬¸ë²• ì˜¤ë¥˜\n\n' + errors.join('\n'));
                return;
            }
            
            // Flink EXPLAIN í˜¸ì¶œ
            const cleanSql = sql.split('\n').filter(line => !line.startsWith('--')).join('\n').trim();
            
            try {
                const res = await fetch('/api/flink/explain', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({sql: cleanSql})
                });
                
                const result = await res.json();
                
                if (result.valid) {
                    copyToClipboard(cleanSql);
                    alert('âœ… Flink ê²€ì¦ í†µê³¼!\n\ní´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.');
                } else {
                    alert('âŒ Flink ê²€ì¦ ì‹¤íŒ¨\n\n' + (result.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
                }
            } catch (e) {
                // Flink ì—°ê²° ì‹¤íŒ¨ ì‹œ ê¸°ë³¸ ê²€ì¦ë§Œ í†µê³¼
                copyToClipboard(cleanSql);
                alert('âœ… ë¬¸ë²• ê²€ì¦ í†µê³¼!\n\n(Flink ì—°ê²° ë¶ˆê°€ - ê¸°ë³¸ ê²€ì¦ë§Œ ìˆ˜í–‰)\n\ní´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.');
            }
        }
        
        function copyToClipboard(text) {
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(text);
            } else {
                // fallback
                const ta = document.createElement('textarea');
                ta.value = text;
                ta.style.position = 'fixed';
                ta.style.left = '-9999px';
                document.body.appendChild(ta);
                ta.select();
                document.execCommand('copy');
                document.body.removeChild(ta);
            }
        }
        
        async function saveRule() {
            const name = document.getElementById('builderRuleName').value.trim();
            const ruleType = document.getElementById('builderRuleType').value;
            
            if (!name) { alert('ê·œì¹™ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”'); return; }
            if (nodes.length === 0) { alert('ë…¸ë“œë¥¼ ì¶”ê°€í•˜ì„¸ìš”'); return; }
            
            // ê·œì¹™ëª… ì¤‘ë³µ ì²´í¬
            const ruleId = name.replace(/\s+/g, '_').replace(/[^a-zA-Z0-9ê°€-í£_-]/g, '');
            if (rulesData[ruleId]) {
                alert('âŒ ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ê·œì¹™ëª…ì…ë‹ˆë‹¤.\n\në‹¤ë¥¸ ì´ë¦„ì„ ì‚¬ìš©í•˜ì„¸ìš”.');
                return;
            }
            
            const actionNode = nodes.find(n => n.type === 'action');
            const eventNodes = nodes.filter(n => n.type === 'event');
            
            if (eventNodes.length === 0) { alert('ì´ë²¤íŠ¸ ë…¸ë“œë¥¼ ì¶”ê°€í•˜ì„¸ìš”'); return; }
            if (!actionNode) { alert('ì•¡ì…˜ ë…¸ë“œë¥¼ ì¶”ê°€í•˜ì„¸ìš”'); return; }
            
            const firstEvent = eventNodes[0];
            
            // patterns êµ¬ì¡°ë¡œ ë³€í™˜
            const orderedEvents = [];
            if (edges.length > 0 && eventNodes.length >= 2) {
                // ì—°ê²°ì„  ìˆœì„œëŒ€ë¡œ ì •ë ¬
                let current = eventNodes.find(n => !edges.some(e => e.to === n.id));
                let order = 1;
                while (current) {
                    orderedEvents.push({node: current, order: order++});
                    const edge = edges.find(e => e.from === current.id);
                    current = edge ? eventNodes.find(n => n.id === edge.to) : null;
                }
            } else {
                eventNodes.forEach((n, i) => orderedEvents.push({node: n, order: i + 1}));
            }
            
            const patterns = orderedEvents.map(({node, order}) => {
                const p = {
                    match: {
                        msgId: node.data.msgId,
                        conditions: node.data.conditions.map(c => ({
                            field: c.field,
                            op: c.op === '=' ? 'eq' : c.op === '>' ? 'gt' : c.op === '>=' ? 'gte' : c.op === '<' ? 'lt' : c.op,
                            value: c.value
                        }))
                    }
                };
                if (eventNodes.length >= 2) p.order = order;
                if (node.data.count > 1) p.quantifier = {min: node.data.count};
                return p;
            });
            
            const rule = {
                name: name,
                severity: actionNode.data.severity,
                description: actionNode.data.message,
                enabled: true,
                patterns: patterns,
                by: ['userId'],
                sql: document.getElementById('sqlPreview').textContent
            };
            
            // ìœˆë„ìš°/ì§‘ê³„ ì„¤ì •
            if (eventNodes.length >= 2) {
                const edge = edges[0];
                rule.within = edge?.within || firstEvent.data.window || '10m';
            } else if (firstEvent.data.window && firstEvent.data.count > 1) {
                rule.aggregate = {count: {min: firstEvent.data.count}, within: firstEvent.data.window};
            } else if (firstEvent.data.window) {
                rule.within = firstEvent.data.window;
            }
            
            try {
                const res = await fetch('/api/cep/rules', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(rule)
                });
                
                if (res.ok) {
                    alert(`âœ… CEP ê·œì¹™ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!\n\nID: ${ruleId}`);
                    closeBuilder();
                    location.reload();
                } else {
                    const err = await res.text();
                    alert('âŒ ì €ì¥ ì‹¤íŒ¨: ' + err);
                }
            } catch (e) {
                alert('âŒ ì €ì¥ ì˜¤ë¥˜: ' + e.message);
            }
        }
        // ========== ë§ˆì´ê·¸ë ˆì´ì…˜ ==========
        let migMeta = {events: {}};  // í˜„ì¬ ë©”íƒ€ë°ì´í„°
        let migAnalysis = {};        // analyze ê²°ê³¼
        let migSelectedEvent = null;

        function openMigration() {
            document.getElementById('migrationModal').classList.add('show');
            // ê¸°ì¡´ ë©”íƒ€ë°ì´í„° ë¡œë“œ
            fetch('/api/cep/field-meta').then(r=>r.json()).then(data => {
                migMeta = data || {events:{}};
                if (migMeta.migratedAt) {
                    document.getElementById('migLastDate').textContent = 'ìµœê·¼: ' + new Date(migMeta.migratedAt).toLocaleString('ko-KR');
                }
                // ê¸°ì¡´ ë°ì´í„°ê°€ ìˆìœ¼ë©´ ì´ë²¤íŠ¸ ëª©ë¡ ë°”ë¡œ í‘œì‹œ
                const evKeys = Object.keys(migMeta.events || {});
                if (evKeys.length > 0) {
                    // ê¸°ì¡´ ë°ì´í„°ë¥¼ migAnalysisì—ë„ ë°˜ì˜ (í•„ë“œ ëª©ë¡ìš©)
                    evKeys.forEach(evId => {
                        if (!migAnalysis[evId]) {
                            migAnalysis[evId] = { fields: Object.keys(migMeta.events[evId].fields || {}), sampleCount: 0 };
                        }
                    });
                    renderMigEventList();
                    document.getElementById('migAnalyzeStatus').textContent = `ì €ì¥ëœ ë°ì´í„°: ${evKeys.length}ê°œ ì´ë²¤íŠ¸`;
                }
            });
        }

        function closeMigration() {
            document.getElementById('migrationModal').classList.remove('show');
        }

        // ìƒìœ„ ë§ˆì´ê·¸ë ˆì´ì…˜: Nì¼ì¹˜ ì´ë²¤íŠ¸ ë¶„ì„
        async function runAnalyze() {
            const days = parseInt(document.getElementById('migDays').value) || 7;
            const mode = document.getElementById('migMode').value;
            const list = document.getElementById('migEventList');
            const status = document.getElementById('migAnalyzeStatus');
            list.innerHTML = '<div class="text-center text-gray-400 text-sm py-4">ë¶„ì„ ì¤‘...</div>';
            status.textContent = 'ë¶„ì„ ì¤‘...';

            // ë®ì–´ì“°ê¸° ëª¨ë“œë©´ ê¸°ì¡´ ë°ì´í„° ì´ˆê¸°í™”
            if (mode === 'overwrite') {
                migMeta = {events: {}};
            }

            const res = await fetch('/api/cep/field-meta/analyze', {
                method: 'POST', headers: {'Content-Type':'application/json'},
                body: JSON.stringify({days})
            });
            const data = await res.json();
            migAnalysis = data.events || {};

            status.textContent = `${days}ì¼ì¹˜ Â· ${Object.keys(migAnalysis).length}ê°œ ì´ë²¤íŠ¸ Â· ${mode === 'merge' ? 'ë³‘í•© ëª¨ë“œ' : 'ë®ì–´ì“°ê¸° ëª¨ë“œ'}`;
            renderMigEventList();
        }

        // ì´ë²¤íŠ¸ ëª©ë¡ ë Œë”ë§ (ê³µí†µ)
        function renderMigEventList() {
            const list = document.getElementById('migEventList');
            list.innerHTML = '';
            const allEvents = new Set([...Object.keys(migAnalysis), ...Object.keys(migMeta.events || {})]);
            if (allEvents.size === 0) {
                list.innerHTML = '<div class="text-center text-gray-400 text-sm py-8">ë¶„ì„ì„ ì‹¤í–‰í•˜ì„¸ìš”</div>';
                return;
            }
            const sorted = [...allEvents].sort((a,b) => {
                const ca = migAnalysis[a]?.sampleCount || 0, cb = migAnalysis[b]?.sampleCount || 0;
                return cb - ca;
            });
            sorted.forEach(evId => {
                const hasConfig = !!migMeta.events?.[evId];
                const enabled = hasConfig ? migMeta.events[evId].enabled !== false : false;
                const fieldCount = hasConfig ? Object.keys(migMeta.events[evId].fields || {}).length : 0;
                const count = migAnalysis[evId]?.sampleCount || 0;
                const isSelected = migSelectedEvent === evId;
                const btn = document.createElement('div');

                if (enabled) {
                    btn.className = `px-3 py-2 rounded cursor-pointer text-sm flex justify-between items-center bg-green-50 border border-green-200 ${isSelected ? 'ring-2 ring-blue-400' : ''}`;
                    const badge = fieldCount > 0
                        ? `<span class="text-xs bg-green-100 text-green-700 px-2 py-0.5 rounded-full">${fieldCount}í•„ë“œ</span>`
                        : `<span class="text-xs bg-yellow-100 text-yellow-700 px-2 py-0.5 rounded-full">ì„¤ì • í•„ìš”</span>`;
                    btn.innerHTML = `<div class="flex items-center gap-2">
                        <input type="checkbox" checked onclick="event.stopPropagation(); toggleEventEnabled('${evId}', this.checked)" class="accent-green-600 w-4 h-4">
                        <span class="font-medium text-green-800">${evId.replace('MESSAGE_','')}</span>
                    </div>${badge}`;
                } else {
                    btn.className = `px-3 py-2 rounded cursor-pointer text-sm flex justify-between items-center border border-dashed border-gray-300 hover:bg-gray-50 ${isSelected ? 'ring-2 ring-blue-400' : ''}`;
                    btn.innerHTML = `<div class="flex items-center gap-2">
                        <input type="checkbox" onclick="event.stopPropagation(); toggleEventEnabled('${evId}', this.checked)" class="accent-gray-400 w-4 h-4">
                        <span class="text-gray-500">${evId.replace('MESSAGE_','')}</span>
                    </div><span class="text-xs text-gray-400">${count ? count.toLocaleString()+'ê±´' : 'ë¯¸ì„¤ì •'}</span>`;
                }
                btn.onclick = (e) => {
                    if (e.target.tagName !== 'INPUT') selectMigEvent(evId);
                };
                list.appendChild(btn);
            });
        }

        function toggleEventEnabled(evId, checked) {
            if (!migMeta.events) migMeta.events = {};
            if (!migMeta.events[evId]) {
                migMeta.events[evId] = {label: '', enabled: checked, fields: {}};
                if (migAnalysis[evId]) {
                    migAnalysis[evId].fields.forEach(f => {
                        migMeta.events[evId].fields[f] = {};
                    });
                }
            } else {
                migMeta.events[evId].enabled = checked;
            }
            requestAnimationFrame(renderMigEventList);
        }
        function selectMigEvent(evId) {
            migSelectedEvent = evId;
            // ì¢Œì¸¡ í•˜ì´ë¼ì´íŠ¸
            document.querySelectorAll('#migEventList > div').forEach(el => {
                el.classList.toggle('bg-blue-100', el.textContent.includes(evId.replace('MESSAGE_','')));
            });

            const area = document.getElementById('migFieldArea');
            const analysis = migAnalysis[evId] || {fields:[]};
            const existing = migMeta.events?.[evId] || {};

            // ê°€ìƒ í•„ë“œ ì •ì˜ (ì´ë²¤íŠ¸ ë°œìƒ ì‹œê° ê¸°ì¤€, inputType ê³ ì •)
            const virtualFields = [
                {field: 'time', fixedType: 'time_range', defaultLabel: 'ë°œìƒ ì‹œê°„ëŒ€'},
                {field: 'dayOfWeek', fixedType: 'dayOfWeek', defaultLabel: 'ë°œìƒ ìš”ì¼'}
            ];

            // í•„ë“œ ì¹´ë“œ ë Œë” í•¨ìˆ˜
            function renderFieldCard(field, fm, vf) {
                const isVirtual = !!vf;
                const isConfigured = !!fm.inputType;
                const borderClass = isVirtual
                    ? (isConfigured ? 'border-blue-200 bg-blue-50/30' : 'border-blue-100 bg-blue-50/10')
                    : (isConfigured ? 'border-green-200 bg-green-50/30' : 'border-gray-200 bg-white');
                const codeClass = isVirtual
                    ? 'bg-blue-100 text-blue-800'
                    : (isConfigured ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-600');
                // ê°€ìƒ í•„ë“œ: ì²´í¬ + ë¼ë²¨ë§Œ. ì¼ë°˜ í•„ë“œ: ì „ì²´ UI
                if (isVirtual) {
                    const vAttr = ` data-virtual="true" data-fixed-type="${vf.fixedType}"`;
                    return `<div class="border rounded-lg p-3 ${borderClass}" data-field="${field}"${vAttr}>
                        <div class="flex items-center gap-3 flex-nowrap">
                            <input type="checkbox" class="mig-virtual-chk accent-blue-600 w-4 h-4" ${isConfigured?'checked':''} onchange="toggleVirtualField(this, '${field}', '${vf.fixedType}')">
                            <code class="text-xs ${codeClass} px-2 py-1 rounded font-mono w-36 shrink-0">${field}</code>
                            <input type="text" class="form-input text-sm flex-1 min-w-[120px] mig-field-label" value="${fm.label || ''}" placeholder="í•œê¸€ ë¼ë²¨">
                            <span class="text-xs bg-blue-100 text-blue-700 px-2 py-1 rounded shrink-0">${vf.fixedType}</span>
                            <input type="hidden" class="mig-field-type" value="${fm.inputType || ''}">
                        </div>
                    </div>`;
                }

                const rawOps = fm.operators || (fm.inputType ? defaultOperators[fm.inputType] : []);
                const activeOps = new Set(rawOps.map(o => typeof o === 'string' ? o : o.op));
                const opsCheckboxes = fm.inputType ? renderOpsCheckboxes(field, activeOps) : '';
                const statusBadge = isConfigured
                    ? `<span class="text-xs bg-green-100 text-green-700 px-1.5 py-0.5 rounded shrink-0 whitespace-nowrap mig-status-badge">âœ“ ${fm.inputType}</span>`
                    : `<span class="text-xs bg-gray-100 text-gray-400 px-1.5 py-0.5 rounded shrink-0 whitespace-nowrap mig-status-badge">ë¯¸ì„¤ì •</span>`;
                let extraArea = renderOptionsArea(field, fm);
                if (fm.inputType === 'number') {
                    extraArea += `<div class="mt-2 flex items-center gap-2">
                        <span class="text-xs text-gray-500">ë‹¨ìœ„:</span>
                        <input type="text" class="form-input text-xs w-24 mig-field-unit" value="${fm.unit || ''}" placeholder="ì˜ˆ: bytes, ì¥, ê±´">
                    </div>`;
                }
                return `<div class="border rounded-lg p-3 ${borderClass}" data-field="${field}">
                    <div class="flex items-center gap-3 mb-2 flex-nowrap">
                        <code class="text-xs ${codeClass} px-2 py-1 rounded font-mono w-36 shrink-0 truncate" title="${field}">${field}</code>
                        ${statusBadge}
                        <input type="text" class="form-input text-sm flex-1 min-w-[120px] mig-field-label" value="${fm.label || ''}" placeholder="í•œê¸€ ë¼ë²¨">
                        <select class="form-input text-sm w-48 shrink-0 mig-field-type" onchange="onInputTypeChange(this, '${evId}', '${field}')">
                            <option value="">ë¯¸ì„¤ì •</option>
                            <option value="select" ${fm.inputType==='select'?'selected':''}>select (ë“œë¡­ë‹¤ìš´)</option>
                            <option value="checkbox" ${fm.inputType==='checkbox'?'selected':''}>checkbox (ë‹¤ì¤‘ì„ íƒ)</option>
                            <option value="input" ${fm.inputType==='input'?'selected':''}>input (ììœ ì…ë ¥)</option>
                            <option value="number" ${fm.inputType==='number'?'selected':''}>number (ìˆ«ì)</option>
                            <option value="time_range" ${fm.inputType==='time_range'?'selected':''}>time_range (ì‹œê°„ë²”ìœ„)</option>
                            <option value="dayOfWeek" ${fm.inputType==='dayOfWeek'?'selected':''}>dayOfWeek (ìš”ì¼)</option>
                        </select>
                    </div>
                    ${opsCheckboxes ? `<div class="mb-2 mig-ops-area">${opsCheckboxes}</div>` : `<div class="mb-2 mig-ops-area"></div>`}
                    ${fm.inputType ? `<div class="mb-2 flex items-center gap-2">
                        <span class="text-xs text-gray-500 shrink-0">ê°’ í˜•ì‹:</span>
                        <code class="text-xs bg-yellow-50 text-yellow-800 border border-yellow-200 px-1.5 py-0.5 rounded mig-vf-example">${(fm.valueFormat || defaultValueFormats[fm.inputType] || {}).example || ''}</code>
                        <input type="text" class="form-input text-xs flex-1 mig-vf-desc" value="${(fm.valueFormat || defaultValueFormats[fm.inputType] || {}).desc || ''}" placeholder="ê°’ í˜•ì‹ ì„¤ëª…">
                    </div>` : ''}
                    <div class="mig-options-area" id="opts_${field}">
                        ${extraArea}
                    </div>
                </div>`;
            }

            // â”€â”€ ê³µí†µ ì¡°ê±´ (ìœ„) â”€â”€
            let html = `<div class="mb-4">
                <label class="form-label">ì´ë²¤íŠ¸ í•œê¸€ëª…</label>
                <input type="text" id="migEvLabel" class="form-input text-sm" value="${existing.label || ''}" placeholder="ì˜ˆ: ì¥ì¹˜ ì‚¬ìš©">
            </div>
            <h4 class="font-semibold text-sm mb-3 text-blue-700">â° ê³µí†µ ì¡°ê±´ (ì´ë²¤íŠ¸ ë°œìƒ ì‹œê°)</h4>
            <div class="space-y-3" id="migVirtualFields">`;
            virtualFields.forEach(vf => {
                const fm = existing.fields?.[vf.field] || {label: vf.defaultLabel};
                if (!fm.label) fm.label = vf.defaultLabel;
                html += renderFieldCard(vf.field, fm, vf);
            });

            // â”€â”€ ì†ì„± í•„ë“œ (ì•„ë˜) â”€â”€
            html += `</div>
            <h4 class="font-semibold text-sm mt-5 mb-3">í•„ë“œ ëª©ë¡ (${analysis.fields.length}ê°œ)</h4>
            <div class="space-y-3" id="migFieldList">`;
            analysis.fields.forEach(field => {
                const fm = existing.fields?.[field] || {};
                html += renderFieldCard(field, fm, null);
            });

            html += '</div>';
            area.innerHTML = html;
        }

        // ì—°ì‚°ì ì²´í¬ë°•ìŠ¤ ë Œë”ë§
        function renderOpsCheckboxes(field, activeOps) {
            return `<div class="flex flex-wrap gap-1 items-center">
                <span class="text-xs text-gray-500 mr-1">ì—°ì‚°ì:</span>
                ${allOperators.map(op => `<label class="inline-flex items-center gap-0.5 text-xs cursor-pointer select-none">
                    <input type="checkbox" class="mig-op-chk" data-op="${op}" ${activeOps.has(op)?'checked':''}>
                    <span class="${activeOps.has(op)?'text-blue-600 font-medium':'text-gray-400'}">${operatorLabels[op]||op}</span>
                </label>`).join('')}
            </div>`;
        }

        function renderOptionsArea(field, fm) {
            if (!fm.inputType || fm.inputType === 'input' || fm.inputType === 'number') return '';
            if (fm.inputType === 'select' || fm.inputType === 'checkbox') {
                const opts = fm.options || [];
                let h = `<div class="mt-2 space-y-1">
                    <div class="flex justify-between items-center">
                        <span class="text-xs text-gray-500">ì˜µì…˜ ëª©ë¡</span>
                        <div class="flex gap-1">
                            <button onclick="addManualOption('${field}')" class="text-xs px-2 py-1 rounded" style="background:#10b981;color:white">+ ì¶”ê°€</button>
                            <button onclick="analyzeFieldValues('${migSelectedEvent}','${field}')" class="text-xs px-2 py-1 rounded" style="background:#3b82f6;color:white">ğŸ” ê°’ ìˆ˜ì§‘</button>
                        </div>
                    </div>
                    <div class="mig-opts-list space-y-1">`;
                opts.forEach((o, i) => {
                    h += `<div class="flex gap-2 items-center">
                        <code class="text-xs bg-gray-50 px-2 py-0.5 w-44 truncate" title="${o.value}">${o.value}</code>
                        <input type="text" class="form-input text-xs flex-1 mig-opt-label" data-idx="${i}" value="${o.label || ''}" placeholder="í•œê¸€ ë¼ë²¨">
                        <button onclick="this.closest('div').remove()" class="text-red-400 text-xs">âœ•</button>
                    </div>`;
                });
                h += '</div></div>';
                return h;
            }
            if (fm.inputType === 'time_range') {
                return `<div class="mt-2 text-xs text-gray-500">
                    ê·œì¹™ ì‘ì„± ì‹œ ì‹œì‘/ì¢…ë£Œ ì‹œê°(0~23)ì„ ì…ë ¥ë°›ìŠµë‹ˆë‹¤. ì•¼ê°„ wrap(ì˜ˆ: 22~6) ìë™ ì§€ì›.
                </div>`;
            }
            if (fm.inputType === 'dayOfWeek') {
                const days = ['ì¼','ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† '];
                const opts = fm.options || days.map((d,i) => ({value: String(i+1), label: d}));
                let h = `<div class="mt-2 space-y-1">
                    <span class="text-xs text-gray-500">ìš”ì¼ ì˜µì…˜ (value: 1=ì¼~7=í† )</span>
                    <div class="mig-opts-list space-y-1">`;
                opts.forEach((o,i) => {
                    h += `<div class="flex gap-2 items-center">
                        <code class="text-xs bg-gray-50 px-2 py-0.5 w-44">${o.value}</code>
                        <input type="text" class="form-input text-xs flex-1 mig-opt-label" data-idx="${i}" value="${o.label || ''}" placeholder="ë¼ë²¨">
                        <button onclick="this.closest('div').remove()" class="text-red-400 text-xs">âœ•</button>
                    </div>`;
                });
                h += '</div></div>';
                return h;
            }
            return '';
        }

        // inputTypeë³„ ê¸°ë³¸ operators
        const defaultOperators = {
            'select':     ['eq', 'neq'],
            'checkbox':   ['in'],
            'input':      ['eq', 'neq', 'like', 'regex'],
            'number':     ['eq', 'gt', 'gte', 'lt', 'lte'],
            'time_range': ['time_range'],
            'dayOfWeek':  ['in']
        };
        // inputTypeë³„ ê¸°ë³¸ valueFormat
        const defaultValueFormats = {
            'select':     {type:'string',   example:'"removable"',        desc:'ì˜µì…˜ ì¤‘ ë‹¨ì¼ ì„ íƒ'},
            'checkbox':   {type:'string[]', example:'["a","b"]',          desc:'ì˜µì…˜ ì¤‘ ë³µìˆ˜ ì„ íƒ ë°°ì—´'},
            'input':      {type:'string',   example:'"í…ìŠ¤íŠ¸"',            desc:'ììœ  ì…ë ¥ ë¬¸ìì—´'},
            'number':     {type:'number',   example:'1024',               desc:'ìˆ«ì'},
            'time_range': {type:'object',   example:'{"start":22,"end":6}', desc:'ì‹œì‘/ì¢…ë£Œ ì‹œê° (0~23ì‹œ, ì•¼ê°„ wrap ì§€ì›)', schema:{start:'number(0-23)',end:'number(0-23)'}},
            'dayOfWeek':  {type:'number[]', example:'[1,7]',              desc:'ìš”ì¼ ë²ˆí˜¸ ë°°ì—´ (1=ì¼ ~ 7=í† )'}
        };
        // ì „ì²´ ì—°ì‚°ì ëª©ë¡ (ì²´í¬ë°•ìŠ¤ í¸ì§‘ìš©)
        const allOperators = ['eq','neq','gt','gte','lt','lte','in','like','regex','time_range'];
        const operatorLabels = {
            'eq': 'ì¼ì¹˜ (=)', 'neq': 'ë¶ˆì¼ì¹˜ (â‰ )', 'gt': 'ì´ˆê³¼ (>)', 'gte': 'ì´ìƒ (â‰¥)',
            'lt': 'ë¯¸ë§Œ (<)', 'lte': 'ì´í•˜ (â‰¤)', 'in': 'í¬í•¨ (in)', 'like': 'íŒ¨í„´ (like)',
            'regex': 'ì •ê·œì‹', 'time_range': 'ì‹œê°„ë²”ìœ„'
        };

        // ê°€ìƒ í•„ë“œ ì²´í¬ë°•ìŠ¤ í† ê¸€
        function toggleVirtualField(chk, field, fixedType) {
            const card = chk.closest('div[data-field]');
            const hidden = card.querySelector('input.mig-field-type');
            hidden.value = chk.checked ? fixedType : '';
        }

        function onInputTypeChange(sel, evId, field) {
            const type = sel.value;
            const card = sel.closest('div[data-field]');
            const optsArea = document.getElementById('opts_' + field);

            // ì—°ì‚°ì ì²´í¬ë°•ìŠ¤ ê°±ì‹ 
            const opsArea = card.querySelector('.mig-ops-area');
            if (opsArea) {
                if (type) {
                    const activeOps = new Set(defaultOperators[type] || []);
                    opsArea.innerHTML = renderOpsCheckboxes(field, activeOps);
                } else {
                    opsArea.innerHTML = '';
                }
            }

            // ìƒíƒœ ë±ƒì§€ ê°±ì‹ 
            const badge = card.querySelector('.mig-status-badge');
            if (badge) {
                if (type) {
                    badge.className = 'text-xs bg-green-100 text-green-700 px-1.5 py-0.5 rounded shrink-0 whitespace-nowrap mig-status-badge';
                    badge.textContent = 'âœ“ ' + type;
                } else {
                    badge.className = 'text-xs bg-gray-100 text-gray-400 px-1.5 py-0.5 rounded shrink-0 whitespace-nowrap mig-status-badge';
                    badge.textContent = 'ë¯¸ì„¤ì •';
                }
            }

            // ì˜µì…˜ ì˜ì—­
            optsArea.innerHTML = renderOptionsArea(field, {inputType: type, options: []});
            if (type === 'number') {
                const existing = migMeta.events?.[migSelectedEvent]?.fields?.[field] || {};
                optsArea.innerHTML += `<div class="mt-2 flex items-center gap-2">
                    <span class="text-xs text-gray-500">ë‹¨ìœ„ (ì„ íƒ):</span>
                    <input type="text" class="form-input text-xs w-24 mig-field-unit" value="${existing.unit || ''}" placeholder="ì˜ˆ: bytes, ì¥">
                </div>`;
            }

            // valueFormat ê°±ì‹ 
            let vfRow = card.querySelector('.mig-vf-example')?.closest('div');
            if (type) {
                const vf = defaultValueFormats[type] || {};
                const vfHtml = `<div class="mb-2 flex items-center gap-2">
                    <span class="text-xs text-gray-500 shrink-0">ê°’ í˜•ì‹:</span>
                    <code class="text-xs bg-yellow-50 text-yellow-800 border border-yellow-200 px-1.5 py-0.5 rounded mig-vf-example">${vf.example || ''}</code>
                    <input type="text" class="form-input text-xs flex-1 mig-vf-desc" value="${vf.desc || ''}" placeholder="ê°’ í˜•ì‹ ì„¤ëª…">
                </div>`;
                if (vfRow) { vfRow.outerHTML = vfHtml; }
                else { optsArea.insertAdjacentHTML('beforebegin', vfHtml); }
            } else if (vfRow) {
                vfRow.remove();
            }
        }

        // í•˜ìœ„ ë§ˆì´ê·¸ë ˆì´ì…˜: íŠ¹ì • í•„ë“œì˜ ê³ ìœ ê°’ ìˆ˜ì§‘
        async function analyzeFieldValues(evId, field) {
            const days = parseInt(document.getElementById('migDays').value) || 7;
            const res = await fetch('/api/cep/field-meta/analyze-field', {
                method: 'POST', headers: {'Content-Type':'application/json'},
                body: JSON.stringify({event: evId, field, days})
            });
            const data = await res.json();
            const values = data.values || [];

            const optsArea = document.getElementById('opts_' + field);
            // ê¸°ì¡´ ë¼ë²¨ ë³´ì¡´
            const existingLabels = {};
            optsArea.querySelectorAll('.mig-opt-label').forEach(inp => {
                const code = inp.closest('div').querySelector('code');
                if (code) existingLabels[code.textContent] = inp.value;
            });

            let h = `<div class="mt-2 space-y-1">
                <div class="flex justify-between items-center">
                    <span class="text-xs text-gray-500">ì˜µì…˜ ëª©ë¡ (${values.length}ê°œ ìˆ˜ì§‘ë¨)</span>
                    <div class="flex gap-1">
                        <button onclick="addManualOption('${field}')" class="text-xs px-2 py-1 rounded" style="background:#10b981;color:white">+ ì¶”ê°€</button>
                        <button onclick="analyzeFieldValues('${evId}','${field}')" class="text-xs px-2 py-1 rounded" style="background:#3b82f6;color:white">ğŸ” ê°’ ìˆ˜ì§‘</button>
                    </div>
                </div>
                <div class="mig-opts-list space-y-1">`;
            values.forEach((v, i) => {
                const label = existingLabels[v.value] || '';
                h += `<div class="flex gap-2 items-center">
                    <code class="text-xs bg-gray-50 px-2 py-0.5 w-44 truncate" title="${v.value}">${v.value}</code>
                    <input type="text" class="form-input text-xs flex-1 mig-opt-label" data-idx="${i}" value="${label}" placeholder="í•œê¸€ ë¼ë²¨">
                    <span class="text-xs text-gray-300">${v.count}</span>
                    <button onclick="this.closest('div').remove()" class="text-red-400 text-xs">âœ•</button>
                </div>`;
            });
            h += '</div></div>';
            optsArea.innerHTML = h;
        }

        function addManualOption(field) {
            const list = document.querySelector(`#opts_${field} .mig-opts-list`);
            if (!list) return;
            const idx = list.children.length;
            const row = document.createElement('div');
            row.className = 'flex gap-2 items-center';
            row.innerHTML = `
                <input type="text" class="form-input text-xs bg-gray-50 px-2 py-0.5 w-44 mig-opt-value" placeholder="ê°’ ì…ë ¥">
                <input type="text" class="form-input text-xs flex-1 mig-opt-label" data-idx="${idx}" value="" placeholder="í•œê¸€ ë¼ë²¨">
                <button onclick="this.closest('div').remove()" class="text-red-400 text-xs">âœ•</button>`;
            list.appendChild(row);
            row.querySelector('.mig-opt-value').focus();
        }

        // í˜„ì¬ UI ìƒíƒœë¥¼ migMetaì— ë°˜ì˜
        function collectCurrentEvent() {
            if (!migSelectedEvent) return;
            // ì´ë¯¸ ì„¤ì •ëœ ì´ë²¤íŠ¸ë§Œ ì—…ë°ì´íŠ¸ (ë¯¸ì„¤ì • ì´ë²¤íŠ¸ë¥¼ ìë™ ìƒì„±í•˜ì§€ ì•ŠìŒ)
            if (!migMeta.events?.[migSelectedEvent]) return;
            const evLabel = document.getElementById('migEvLabel')?.value || '';
            const fields = {};

            document.querySelectorAll('#migFieldList > div[data-field], #migVirtualFields > div[data-field]').forEach(div => {
                const field = div.dataset.field;
                const label = div.querySelector('.mig-field-label')?.value || '';
                const inputType = div.querySelector('.mig-field-type')?.value || '';
                if (!inputType) return;

                const fm = {label, inputType};
                if (div.dataset.virtual === 'true') {
                    // ê°€ìƒ í•„ë“œ: ê³ ì •ê°’ ìë™ ì„¤ì •
                    fm.virtual = true;
                    fm.operators = (defaultOperators[inputType] || []).map(op => ({op, label: operatorLabels[op] || op}));
                    const vf = defaultValueFormats[inputType] || {};
                    fm.valueFormat = {type: vf.type||'', example: vf.example||'', desc: vf.desc||''};
                    if (vf.schema) fm.valueFormat.schema = vf.schema;
                    fields[field] = fm;
                    return;
                }
                if (inputType === 'select' || inputType === 'checkbox' || inputType === 'dayOfWeek') {
                    fm.options = [];
                    div.querySelectorAll('.mig-opts-list > div').forEach(row => {
                        const val = row.querySelector('code')?.textContent || row.querySelector('.mig-opt-value')?.value || '';
                        const lbl = row.querySelector('.mig-opt-label')?.value || '';
                        if (val) fm.options.push({value: val, label: lbl});
                    });
                }
                // operators: ì²´í¬ë°•ìŠ¤ì—ì„œ ìˆ˜ì§‘
                const checkedOps = [];
                div.querySelectorAll('.mig-op-chk:checked').forEach(chk => {
                    const op = chk.dataset.op;
                    checkedOps.push({op, label: operatorLabels[op] || op});
                });
                fm.operators = checkedOps.length ? checkedOps : (defaultOperators[inputType] || []).map(op => ({
                    op, label: operatorLabels[op] || op
                }));
                // unit (number)
                const unitInput = div.querySelector('.mig-field-unit');
                if (unitInput?.value) fm.unit = unitInput.value;
                // valueFormat
                const vfExample = div.querySelector('.mig-vf-example')?.textContent || '';
                const vfDesc = div.querySelector('.mig-vf-desc')?.value || '';
                if (vfExample) {
                    const base = defaultValueFormats[inputType] || {};
                    fm.valueFormat = {type: (defaultValueFormats[inputType]||{}).type||'', example: vfExample, desc: vfDesc};
                    if (base.schema) fm.valueFormat.schema = base.schema;
                }
                fields[field] = fm;
            });

            const prev = migMeta.events[migSelectedEvent];
            prev.label = evLabel;
            prev.fields = fields;
        }

        // ì €ì¥
        async function saveMigration() {
            collectCurrentEvent();
            migMeta.migratedAt = new Date().toISOString();

            const res = await fetch('/api/cep/field-meta', {
                method: 'PUT', headers: {'Content-Type':'application/json'},
                body: JSON.stringify(migMeta)
            });
            if (res.ok) {
                alert('âœ… ë©”íƒ€ë°ì´í„°ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
                document.getElementById('migLastDate').textContent = 'ìµœê·¼: ' + new Date().toLocaleString('ko-KR');
                renderMigEventList();
            } else {
                alert('âŒ ì €ì¥ ì‹¤íŒ¨');
            }
        }

        // ì´ˆê¸°í™”
        async function resetMigration() {
            if (!confirm('ëª¨ë“  ë©”íƒ€ë°ì´í„°ë¥¼ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
            migMeta = {events: {}};
            migAnalysis = {};
            migSelectedEvent = null;
            const res = await fetch('/api/cep/field-meta', {
                method: 'PUT', headers: {'Content-Type':'application/json'},
                body: JSON.stringify(migMeta)
            });
            if (res.ok) {
                document.getElementById('migEventList').innerHTML = '<div class="text-center text-gray-400 text-sm py-8">ë¶„ì„ì„ ì‹¤í–‰í•˜ì„¸ìš”</div>';
                document.getElementById('migFieldArea').innerHTML = '<div class="text-gray-400 text-center mt-20">â† ë¶„ì„ ì‹¤í–‰ í›„ ì´ë²¤íŠ¸ë¥¼ ì„ íƒí•˜ì„¸ìš”</div>';
                document.getElementById('migLastDate').textContent = '';
                document.getElementById('migAnalyzeStatus').textContent = '';
                alert('ì´ˆê¸°í™” ì™„ë£Œ');
            }
        }

        // ì´ë²¤íŠ¸ ì „í™˜ ì‹œ í˜„ì¬ ìƒíƒœ ì €ì¥ + ëª©ë¡ ê°±ì‹ 
        const origSelectMigEvent = selectMigEvent;
        selectMigEvent = function(evId) {
            collectCurrentEvent();
            origSelectMigEvent(evId);
            renderMigEventList();
        };
    </script>
</body>
</html>
