<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Alert History - SafePC SIEM</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdn.datatables.net/1.13.7/css/dataTables.tailwindcss.min.css" rel="stylesheet">
    <style>
        * { font-family: 'Inter', sans-serif; }
        .nav-menu { position: relative; }
        .nav-item { padding: 8px 16px; font-size: 14px; font-weight: 500; border-radius: 8px; transition: all 0.2s; cursor: pointer; color: white; }
        .nav-item:hover { background: white; color: #1e293b; }
        .nav-item.active { background: #3b82f6; color: white; }
        .nav-item.active:hover { background: #2563eb; color: white; }
        .dropdown { position: absolute; top: 100%; left: 0; margin-top: 4px; background: white; border-radius: 8px; box-shadow: 0 10px 25px rgba(0,0,0,0.15); border: 1px solid #e5e7eb; padding: 4px 0; min-width: 160px; opacity: 0; visibility: hidden; transition: all 0.2s; }
        .nav-menu:hover .dropdown { opacity: 1; visibility: visible; }
        .dropdown a { display: block; padding: 8px 16px; font-size: 14px; color: #374151; }
        .dropdown a:hover { background: #f3f4f6; }
        .dropdown a.active { background: #eff6ff; color: #1d4ed8; font-weight: 500; }
        /* DataTables 커스텀 */
        table.dataTable thead th { font-size: 13px; font-weight: 600; color: #374151; background: #f9fafb; border-bottom: 2px solid #e5e7eb; padding: 14px 16px; text-align: left; cursor: pointer; }
        table.dataTable tbody td { font-size: 12px; padding: 8px 12px; vertical-align: middle; }
        table.dataTable tbody tr:hover { background: #f9fafb; }
        .dataTables_wrapper .dataTables_length, .dataTables_wrapper .dataTables_filter { display: none; }
        .dataTables_wrapper .dataTables_info { font-size: 13px; color: #6b7280; padding: 12px 0; }
        .dataTables_wrapper .dataTables_paginate { padding: 12px 0; }
        .dataTables_wrapper .dataTables_paginate .paginate_button { padding: 6px 12px; margin: 0 2px; border-radius: 6px; border: 1px solid #e5e7eb; background: white; color: #374151 !important; font-size: 13px; }
        .dataTables_wrapper .dataTables_paginate .paginate_button:hover { background: #f3f4f6; border-color: #d1d5db; }
        .dataTables_wrapper .dataTables_paginate .paginate_button.current { background: #3b82f6; border-color: #3b82f6; color: white !important; }
        .dataTables_wrapper .dataTables_paginate .paginate_button.disabled { opacity: 0.5; cursor: not-allowed; }
        .custom-controls { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; padding-bottom: 16px; border-bottom: 1px solid #f3f4f6; }
        .custom-search { display: flex; align-items: center; gap: 12px; }
        .custom-search input { border: 1px solid #e5e7eb; border-radius: 8px; padding: 8px 12px; font-size: 14px; width: 280px; outline: none; transition: border-color 0.2s; }
        .custom-search input:focus { border-color: #3b82f6; }
        .custom-search input::placeholder { color: #9ca3af; }
        .custom-select { display: flex; align-items: center; gap: 8px; font-size: 13px; color: #6b7280; }
        .custom-select select { border: 1px solid #e5e7eb; border-radius: 8px; padding: 8px 12px; font-size: 14px; background: white; cursor: pointer; outline: none; }
        .custom-select select:focus { border-color: #3b82f6; }
        .badge { padding: 4px 10px; font-size: 12px; font-weight: 500; border-radius: 9999px; }
        .badge-critical { background: #fef2f2; color: #b91c1c; }
        .badge-high { background: #fff7ed; color: #c2410c; }
        .badge-medium { background: #fffbeb; color: #b45309; }
        .badge-low { background: #f3f4f6; color: #4b5563; }
        a { cursor: pointer; }
    </style>
</head>
<body class="bg-slate-100 min-h-screen">
    <nav class="bg-gradient-to-r from-slate-900 to-slate-800 text-white sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-6 py-3 flex items-center justify-between">
            <a href="/" class="text-xl font-bold tracking-tight">SafePC <span class="text-blue-400">SIEM</span></a>
            <div class="flex items-center gap-2">
                <a href="/" class="nav-item">Dashboard</a>
                <div class="nav-menu">
                    <span class="nav-item active">Monitoring ▾</span>
                    <div class="dropdown">
                        <a href="/alerts" class="active">Alert History</a>
                        <a href="/logs">Event Logs</a>
                    </div>
                </div>
                <a href="/users" class="nav-item">User Risk</a>
                <a href="/rules" class="nav-item">CEP Rules</a>
                <a href="/settings" class="nav-item">UEBA Settings</a>
            </div>
        </div>
    </nav>

    <main class="max-w-7xl mx-auto px-6 py-5">
        <div class="bg-white rounded-2xl shadow-sm p-6">
            <div class="mb-5">
                <h1 class="text-xl font-bold text-gray-900">Alert History</h1>
                <p class="text-sm text-gray-500 mt-1">CEP 룰 기반 이상행위 탐지 내역 (7일)</p>
            </div>
            <div class="custom-controls">
                <div class="custom-search">
                    <input type="text" id="searchInput" placeholder="검색어를 입력하세요">
                    <select id="ruleFilter" class="ml-2 border border-gray-200 rounded-lg px-3 py-2 text-sm">
                        <option value="">전체 룰</option>
                    </select>
                    <select id="severityFilter" class="ml-2 border border-gray-200 rounded-lg px-3 py-2 text-sm">
                        <option value="">전체 등급</option>
                        <option value="CRITICAL">긴급</option>
                        <option value="HIGH">주의</option>
                        <option value="MEDIUM">보통</option>
                    </select>
                </div>
                <div class="custom-select">
                    <span>표시</span>
                    <select id="pageLength">
                        <option value="10" selected>10</option>
                        <option value="25">25</option>
                        <option value="50">50</option>
                        <option value="100">100</option>
                    </select>
                    <span>개씩</span>
                </div>
            </div>
            <table id="alertTable" class="w-full">
                <thead>
                    <tr>
                        <th>시간 (KST)</th>
                        <th>사용자</th>
                        <th>등급</th>
                        <th>룰 ID</th>
                        <th>룰 이름</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </main>

    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
    <script>
        $(document).ready(function() {
            // 룰 목록 로드
            fetch('/api/rules').then(r => r.json()).then(data => {
                var sel = $('#ruleFilter');
                (data.cep_rules || []).forEach(r => sel.append('<option value="'+r.id+'">'+r.id+' - '+r.name+'</option>'));
            });

            var table = $('#alertTable').DataTable({
                processing: true,
                serverSide: true,
                ajax: {
                    url: '/api/alerts',
                    data: function(d) {
                        return {
                            draw: d.draw, start: d.start, length: d.length,
                            search: d.search.value,
                            order_col: d.order[0].column, order_dir: d.order[0].dir,
                            rule: $('#ruleFilter').val(),
                            severity: $('#severityFilter').val()
                        };
                    }
                },
                columns: [
                    { data: 0, render: function(d) { 
                        if (!d) return '-'; 
                        var dt = new Date(d); 
                        var mm = ('0' + (dt.getUTCMonth()+1)).slice(-2);
                        var dd = ('0' + dt.getUTCDate()).slice(-2);
                        var h = ('0' + ((dt.getUTCHours()+9)%24)).slice(-2);
                        var m = ('0' + dt.getUTCMinutes()).slice(-2);
                        var s = ('0' + dt.getUTCSeconds()).slice(-2);
                        return mm + '-' + dd + ' ' + h + ':' + m + ':' + s;
                    }},
                    { data: 4, render: function(d) { return '<a href="/user/'+d+'" class="text-blue-600 font-medium">'+d+'</a>'; }},
                    { data: 3, render: function(d) {
                        if (d=='CRITICAL') return '<span class="badge badge-critical">긴급</span>';
                        if (d=='HIGH') return '<span class="badge badge-high">주의</span>';
                        return '<span class="badge badge-medium">보통</span>';
                    }},
                    { data: 1, className: 'font-mono text-gray-900' },
                    { data: 2, className: 'text-gray-600' }
                ],
                order: [[0, 'desc']],
                pageLength: 10,
                language: { info: "_TOTAL_건 중 _START_-_END_", emptyTable: "Alert 없음", paginate: { first: "«", previous: "‹", next: "›", last: "»" }}
            });
            $('#searchInput').on('keyup', function() { table.search(this.value).draw(); });
            $('#pageLength').on('change', function() { table.page.len(this.value).draw(); });
            $('#ruleFilter, #severityFilter').on('change', function() { table.draw(); });
        });
    </script>
</body>
</html>
