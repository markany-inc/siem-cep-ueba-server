<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UEBA Settings - SafePC SIEM</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * { font-family: 'Inter', sans-serif; }
        .nav-item { padding: 8px 16px; font-size: 14px; font-weight: 500; border-radius: 8px; transition: all 0.2s; cursor: pointer; color: white; }
        .nav-item:hover { background: white; color: #1e293b; }
        .nav-item.active { background: #3b82f6; color: white; }
        .nav-menu { position: relative; }
        .dropdown { position: absolute; top: 100%; left: 0; margin-top: 4px; background: white; border-radius: 8px; box-shadow: 0 10px 25px rgba(0,0,0,0.15); border: 1px solid #e5e7eb; padding: 4px 0; min-width: 160px; opacity: 0; visibility: hidden; transition: all 0.2s; }
        .nav-menu:hover .dropdown { opacity: 1; visibility: visible; }
        .dropdown a { display: block; padding: 8px 16px; font-size: 14px; color: #374151; }
        .dropdown a:hover { background: #f3f4f6; }
        .card { background: white; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); border: 1px solid #e5e7eb; }
        .input-field { width: 100%; padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px; }
        .input-field:focus { outline: none; border-color: #3b82f6; box-shadow: 0 0 0 3px rgba(59,130,246,0.1); }
        .btn { padding: 8px 16px; font-size: 14px; font-weight: 500; border-radius: 6px; cursor: pointer; transition: all 0.2s; }
        .btn-primary { background: #3b82f6; color: white; }
        .btn-primary:hover { background: #2563eb; }
        .btn-secondary { background: #f3f4f6; color: #374151; border: 1px solid #d1d5db; }
        .btn-secondary:hover { background: #e5e7eb; }
        .tab { padding: 10px 20px; font-size: 14px; font-weight: 500; cursor: pointer; border-bottom: 2px solid transparent; color: #6b7280; }
        .tab:hover { color: #374151; }
        .tab.active { color: #3b82f6; border-bottom-color: #3b82f6; }
        .toast { position: fixed; bottom: 20px; right: 20px; padding: 12px 20px; border-radius: 8px; font-size: 14px; font-weight: 500; transform: translateY(100px); opacity: 0; transition: all 0.3s; }
        .toast.show { transform: translateY(0); opacity: 1; }
        .toast.success { background: #10b981; color: white; }
        .toast.error { background: #ef4444; color: white; }
    </style>
</head>
<body class="bg-slate-100 min-h-screen">
    <nav class="bg-gradient-to-r from-slate-900 to-slate-800 text-white sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-6 py-3 flex items-center justify-between">
            <a href="/" class="text-xl font-bold tracking-tight">SafePC <span class="text-blue-400">SIEM</span></a>
            <div class="flex items-center gap-2">
                <a href="/" class="nav-item">Dashboard</a>
                <div class="nav-menu">
                    <span class="nav-item">Monitoring â–¾</span>
                    <div class="dropdown">
                        <a href="/alerts">Alert History</a>
                        <a href="/logs">Event Logs</a>
                    </div>
                </div>
                <a href="/users" class="nav-item">User Risk</a>
                <a href="/rules" class="nav-item">CEP Rules</a>
                <a href="/settings" class="nav-item active">UEBA Settings</a>
            </div>
        </div>
    </nav>

    <main class="max-w-7xl mx-auto px-6 py-6">
        <div class="flex items-center justify-between mb-6">
            <div>
                <h1 class="text-2xl font-bold text-gray-900">UEBA Settings</h1>
                <p class="text-sm text-gray-500 mt-1">ì‚¬ìš©ì í–‰ë™ ë¶„ì„ ì ìˆ˜ ê³„ì‚° ì„¤ì •</p>
            </div>
            <button onclick="saveSettings()" class="btn btn-primary">ğŸ’¾ ì„¤ì • ì €ì¥</button>
        </div>

        <!-- UEBA ëª¨ë¸ ì„¤ëª… -->
        <div class="bg-blue-50 border border-blue-200 rounded-xl p-5 mb-6">
            <h3 class="font-semibold text-blue-900 mb-3">ğŸ“Š UEBA ìœ„í—˜ë„ ë¶„ì„ ëª¨ë¸</h3>
            <div class="text-sm text-blue-800">
                <p class="font-mono bg-white/50 p-2 rounded text-center mb-3">
                    Risk<sub>t</sub> = (Risk<sub>t-1</sub> Ã— Î») + [Î£(W<sub>i</sub> Ã— f(C<sub>i</sub>) Ã— M<sub>context</sub>) + A<sub>anomaly</sub>]
                </p>
                <div class="grid grid-cols-3 gap-4 text-xs">
                    <div>
                        <div class="font-semibold mb-1">Daily Risk (ì˜¤ëŠ˜ ë°œìƒ ìœ„í—˜)</div>
                        <div><b>W<sub>i</sub></b>: ì´ë²¤íŠ¸ ê°€ì¤‘ì¹˜ (1~10)</div>
                        <div><b>f(C)</b>: ë¹ˆë„ í•¨ìˆ˜ log(C+1)</div>
                        <div><b>M<sub>context</sub></b>: ìƒí™© ê°€ì¤‘ì¹˜</div>
                    </div>
                    <div>
                        <div class="font-semibold mb-1">Anomaly Score (ì´ìƒì¹˜)</div>
                        <div><b>A</b> = Î² Ã— max(0, Z - Z<sub>threshold</sub>)</div>
                        <div>Î²=10, Z<sub>threshold</sub>=2.0</div>
                        <div class="text-gray-600">(í‘œì¤€í¸ì°¨ 2ë°° ì´ˆê³¼ ì‹œ)</div>
                    </div>
                    <div>
                        <div class="font-semibold mb-1">Time Decay (ì‹œê°„ ê°ì‡ )</div>
                        <div>Î»=0.9 (ë§¤ì¼ 10% ê°ì‡ )</div>
                        <div class="text-gray-600">ì•½ 7ì¼ ë°˜ê°ê¸°</div>
                        <div class="text-gray-600">ê³¼ê±° ìœ„í—˜ì€ ì‹œê°„ì´ ì§€ë‚˜ë©´ í¬ì„</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="flex border-b border-gray-200 mb-6">
            <div class="tab active" data-tab="weights">ì´ë²¤íŠ¸ ê°€ì¤‘ì¹˜</div>
            <div class="tab" data-tab="multipliers">ìƒí™© ê°€ì¤‘ì¹˜</div>
            <div class="tab" data-tab="anomaly">ì´ìƒì¹˜ íƒì§€</div>
            <div class="tab" data-tab="decay">ì‹œê°„ ê°ì‡ </div>
            <div class="tab" data-tab="tiers">ë“±ê¸‰ ì„ê³„ì¹˜</div>
        </div>

        <!-- ì´ë²¤íŠ¸ ê°€ì¤‘ì¹˜ -->
        <div id="weights-panel" class="card p-6">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-lg font-semibold">ì´ë²¤íŠ¸ë³„ ê¸°ë³¸ ê°€ì¤‘ì¹˜ (Wi)</h2>
                <span class="text-sm text-gray-500">ì ìˆ˜ = Î£(Wi Ã— f(Ci) Ã— Mcontext)</span>
            </div>
            <div class="grid grid-cols-2 gap-4" id="weights-grid">
                <!-- JSë¡œ ì±„ì›€ -->
            </div>
        </div>

        <!-- ìƒí™© ê°€ì¤‘ì¹˜ -->
        <div id="multipliers-panel" class="card p-6 hidden">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-lg font-semibold">ìƒí™©ë³„ ê°€ì¤‘ì¹˜ (Mcontext)</h2>
                <span class="text-sm text-gray-500">ì‚¬ìš©ì ìƒíƒœì— ë”°ë¥¸ ë°°ìˆ˜</span>
            </div>
            <div class="grid grid-cols-2 gap-4" id="multipliers-grid">
                <!-- JSë¡œ ì±„ì›€ -->
            </div>
        </div>

        <!-- ì´ìƒì¹˜ íƒì§€ -->
        <div id="anomaly-panel" class="card p-6 hidden">
            <div class="mb-4">
                <h2 class="text-lg font-semibold">ì´ìƒì¹˜ íƒì§€ ì„¤ì • (Z-Score)</h2>
                <p class="text-sm text-gray-500 mt-1">Anomaly = Î² Ã— max(0, Z - threshold)</p>
            </div>
            <div class="grid grid-cols-2 gap-6">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Z-Score ì„ê³„ì¹˜ (z_threshold)</label>
                    <input type="number" step="0.1" id="z_threshold" class="input-field" placeholder="2.0">
                    <p class="text-xs text-gray-500 mt-1">ì´ ê°’ ì´í•˜ì˜ Z-ScoreëŠ” ë¬´ì‹œ (ê¸°ë³¸: 2.0)</p>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">ë³€í™˜ ê³„ìˆ˜ (beta)</label>
                    <input type="number" step="1" id="beta" class="input-field" placeholder="10">
                    <p class="text-xs text-gray-500 mt-1">Z-Score 1ë‹¹ ê°€ì‚° ì ìˆ˜ (ê¸°ë³¸: 10)</p>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">ìµœì†Œ í‘œì¤€í¸ì°¨ (sigma_floor)</label>
                    <input type="number" step="0.1" id="sigma_floor" class="input-field" placeholder="0.5">
                    <p class="text-xs text-gray-500 mt-1">0 ë‚˜ëˆ„ê¸° ë°©ì§€ìš© ìµœì†Œê°’ (ê¸°ë³¸: 0.5)</p>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Baseline ìœˆë„ìš° (ì¼)</label>
                    <input type="number" id="baseline_window_days" class="input-field" placeholder="30">
                    <p class="text-xs text-gray-500 mt-1">í‰ê· /í‘œì¤€í¸ì°¨ ê³„ì‚° ê¸°ê°„ (ê¸°ë³¸: 30ì¼)</p>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Cold Start ìµœì†Œ ì¼ìˆ˜</label>
                    <input type="number" id="cold_start_min_days" class="input-field" placeholder="7">
                    <p class="text-xs text-gray-500 mt-1">ê°œì¸ Baseline ìµœì†Œ ë°ì´í„° ì¼ìˆ˜ (ê¸°ë³¸: 7ì¼)</p>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">ë¹ˆë„ í•¨ìˆ˜</label>
                    <select id="frequency_function" class="input-field">
                        <option value="log">log (ìì—°ë¡œê·¸)</option>
                        <option value="log2">log2 (ì´ì§„ë¡œê·¸)</option>
                        <option value="log10">log10 (ìƒìš©ë¡œê·¸)</option>
                        <option value="linear">linear (ì„ í˜•)</option>
                    </select>
                    <p class="text-xs text-gray-500 mt-1">f(C) = log(C+1) ë“±</p>
                </div>
            </div>
        </div>

        <!-- ì‹œê°„ ê°ì‡  -->
        <div id="decay-panel" class="card p-6 hidden">
            <div class="mb-4">
                <h2 class="text-lg font-semibold">ì‹œê°„ ê°ì‡  ì„¤ì • (Time Decay)</h2>
                <p class="text-sm text-gray-500 mt-1">Rt = Rt-1 Ã— Î» + St (ê³¼ê±° ì ìˆ˜ ê°ì‡ )</p>
            </div>
            <div class="grid grid-cols-2 gap-6">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">ê°ì‡  ê³„ìˆ˜ (lambda)</label>
                    <input type="number" step="0.01" id="decay_lambda" class="input-field" placeholder="0.9">
                    <p class="text-xs text-gray-500 mt-1">0.9 = ì•½ 7ì¼ ë°˜ê°ê¸°, 0.8 = ì•½ 3ì¼ ë°˜ê°ê¸°</p>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">ì£¼ë§ ì²˜ë¦¬</label>
                    <select id="weekend_mode" class="input-field">
                        <option value="time">Time-based (ì£¼ë§ í¬í•¨ ê°ì‡ )</option>
                        <option value="activity">Activity-based (ì ‘ì†ì¼ë§Œ)</option>
                    </select>
                    <p class="text-xs text-gray-500 mt-1">ì£¼ë§ì—ë„ ì ìˆ˜ ê°ì‡  ì ìš© ì—¬ë¶€</p>
                </div>
            </div>
            <div class="mt-6 p-4 bg-blue-50 rounded-lg">
                <h3 class="font-medium text-blue-900 mb-2">ë°˜ê°ê¸° ì°¸ê³ </h3>
                <div class="text-sm text-blue-800 grid grid-cols-3 gap-2">
                    <span>Î»=0.5 â†’ 1ì¼</span>
                    <span>Î»=0.8 â†’ 3ì¼</span>
                    <span>Î»=0.9 â†’ 7ì¼</span>
                    <span>Î»=0.95 â†’ 14ì¼</span>
                    <span>Î»=0.99 â†’ 69ì¼</span>
                </div>
            </div>
        </div>

        <!-- ë“±ê¸‰ ì„ê³„ì¹˜ -->
        <div id="tiers-panel" class="card p-6 hidden">
            <div class="mb-4">
                <h2 class="text-lg font-semibold">ìœ„í—˜ ë“±ê¸‰ ì„ê³„ì¹˜</h2>
                <p class="text-sm text-gray-500 mt-1">ì ìˆ˜ êµ¬ê°„ë³„ ë“±ê¸‰ ë¶„ë¥˜</p>
            </div>
            <div class="grid grid-cols-3 gap-6">
                <div class="p-4 bg-green-50 rounded-lg border border-green-200">
                    <div class="flex items-center gap-2 mb-3">
                        <span class="w-3 h-3 bg-green-500 rounded-full"></span>
                        <span class="font-semibold text-green-800">Green (ê´€ì‹¬)</span>
                    </div>
                    <label class="block text-sm text-green-700 mb-1">ìµœëŒ€ ì ìˆ˜</label>
                    <input type="number" id="tier_green_max" class="input-field" placeholder="40">
                    <p class="text-xs text-green-600 mt-1">0 ~ ì´ ê°’ê¹Œì§€</p>
                </div>
                <div class="p-4 bg-yellow-50 rounded-lg border border-yellow-200">
                    <div class="flex items-center gap-2 mb-3">
                        <span class="w-3 h-3 bg-yellow-500 rounded-full"></span>
                        <span class="font-semibold text-yellow-800">Yellow (ì£¼ì˜)</span>
                    </div>
                    <label class="block text-sm text-yellow-700 mb-1">ìµœëŒ€ ì ìˆ˜</label>
                    <input type="number" id="tier_yellow_max" class="input-field" placeholder="99">
                    <p class="text-xs text-yellow-600 mt-1">Green ì´ˆê³¼ ~ ì´ ê°’ê¹Œì§€</p>
                </div>
                <div class="p-4 bg-red-50 rounded-lg border border-red-200">
                    <div class="flex items-center gap-2 mb-3">
                        <span class="w-3 h-3 bg-red-500 rounded-full"></span>
                        <span class="font-semibold text-red-800">Red (ìœ„í—˜)</span>
                    </div>
                    <p class="text-sm text-red-700 mt-6">Yellow ì´ˆê³¼</p>
                    <p class="text-xs text-red-600 mt-1">100ì  ì´ìƒ</p>
                </div>
            </div>
        </div>
    </main>

    <div id="toast" class="toast"></div>

    <script>
        // ê¸°ë³¸ê°’
        const defaults = {
            weights: {},
            multipliers: {
                normal: { name: 'ì¼ë°˜ (Normal)', multiplier: 1.0, desc: 'ì¼ë°˜ ì‚¬ìš©ì' },
                departing: { name: 'í‡´ì‚¬ ì˜ˆì • (Departing)', multiplier: 2.0, desc: 'í‡´ì‚¬ ì˜ˆì •ì - ìœ„í—˜ë„ 2ë°°' },
                vacation: { name: 'íœ´ê°€ ì¤‘ (Vacation)', multiplier: 1.5, desc: 'íœ´ê°€ ì¤‘ ì ‘ì†' },
                blacklist: { name: 'ë¸”ë™ë¦¬ìŠ¤íŠ¸ (Blacklist)', multiplier: 2.0, desc: 'ë¸”ë™ë¦¬ìŠ¤íŠ¸ ì‚¬ìš©ì' },
                probation: { name: 'ìˆ˜ìŠµ ê¸°ê°„ (Probation)', multiplier: 1.3, desc: 'ìˆ˜ìŠµ ê¸°ê°„ ì¤‘' },
                contractor: { name: 'ì™¸ë¶€ ìš©ì—­ (Contractor)', multiplier: 1.5, desc: 'ì™¸ë¶€ ìš©ì—­/í˜‘ë ¥ì‚¬' },
                vip: { name: 'VIP', multiplier: 0.5, desc: 'VIP - ìœ„í—˜ë„ ê°ì†Œ' }
            },
            anomaly: { z_threshold: 2.0, beta: 10, sigma_floor: 0.5, baseline_window_days: 30, cold_start_min_days: 7, frequency_function: 'log' },
            decay: { lambda: 0.9, weekend_mode: 'time' },
            tiers: { green_max: 40, yellow_max: 99 }
        };

        let settings = JSON.parse(JSON.stringify(defaults));

        // íƒ­ ì „í™˜
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', function() {
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                this.classList.add('active');
                ['weights', 'multipliers', 'anomaly', 'decay', 'tiers'].forEach(p => {
                    document.getElementById(p + '-panel').classList.toggle('hidden', this.dataset.tab !== p);
                });
            });
        });

        // ì„¤ì • ë¡œë“œ
        async function loadSettings() {
            try {
                const r = await fetch('/api/ueba/settings');
                if (r.ok) {
                    const data = await r.json();
                    if (data && Object.keys(data).length > 0) {
                        for (const key of Object.keys(defaults)) {
                            if (data[key]) settings[key] = { ...defaults[key], ...data[key] };
                        }
                        if (data.weights) settings.weights = data.weights;
                        if (data.multipliers) settings.multipliers = data.multipliers;
                    }
                }
            } catch (e) { console.log('Using defaults'); }
            renderSettings();
        }

        // ë Œë”ë§
        function renderSettings() {
            // ê°€ì¤‘ì¹˜
            const wGrid = document.getElementById('weights-grid');
            wGrid.innerHTML = '';
            for (const [key, val] of Object.entries(settings.weights)) {
                wGrid.innerHTML += `
                    <div class="flex items-center gap-3 p-3 bg-gray-50 rounded-lg">
                        <div class="flex-1">
                            <div class="font-medium text-gray-900">${val.name}</div>
                            <div class="text-xs text-gray-500">${val.msgId}</div>
                        </div>
                        <input type="number" min="1" max="10" value="${val.weight}" 
                            onchange="settings.weights['${key}'].weight = +this.value"
                            class="w-20 input-field text-center font-semibold">
                    </div>`;
            }

            // ìƒí™© ê°€ì¤‘ì¹˜
            const mGrid = document.getElementById('multipliers-grid');
            mGrid.innerHTML = '';
            for (const [key, val] of Object.entries(settings.multipliers)) {
                mGrid.innerHTML += `
                    <div class="flex items-center gap-3 p-3 bg-gray-50 rounded-lg">
                        <div class="flex-1">
                            <div class="font-medium text-gray-900">${val.name}</div>
                            <div class="text-xs text-gray-500">${val.desc || key}</div>
                        </div>
                        <input type="number" step="0.1" min="0.1" max="5" value="${val.multiplier}" 
                            onchange="settings.multipliers['${key}'].multiplier = +this.value"
                            class="w-20 input-field text-center font-semibold">
                        <span class="text-gray-500">Ã—</span>
                    </div>`;
            }

            // ì´ìƒì¹˜ íƒì§€
            document.getElementById('z_threshold').value = settings.anomaly.z_threshold;
            document.getElementById('beta').value = settings.anomaly.beta;
            document.getElementById('sigma_floor').value = settings.anomaly.sigma_floor;
            document.getElementById('baseline_window_days').value = settings.anomaly.baseline_window_days;
            document.getElementById('cold_start_min_days').value = settings.anomaly.cold_start_min_days;
            document.getElementById('frequency_function').value = settings.anomaly.frequency_function;

            // ì‹œê°„ ê°ì‡ 
            document.getElementById('decay_lambda').value = settings.decay.lambda;
            document.getElementById('weekend_mode').value = settings.decay.weekend_mode;

            // ë“±ê¸‰
            document.getElementById('tier_green_max').value = settings.tiers.green_max;
            document.getElementById('tier_yellow_max').value = settings.tiers.yellow_max;
        }

        // ì €ì¥
        async function saveSettings() {
            // ì…ë ¥ê°’ ìˆ˜ì§‘
            settings.anomaly.z_threshold = +document.getElementById('z_threshold').value;
            settings.anomaly.beta = +document.getElementById('beta').value;
            settings.anomaly.sigma_floor = +document.getElementById('sigma_floor').value;
            settings.anomaly.baseline_window_days = +document.getElementById('baseline_window_days').value;
            settings.anomaly.cold_start_min_days = +document.getElementById('cold_start_min_days').value;
            settings.anomaly.frequency_function = document.getElementById('frequency_function').value;
            settings.decay.lambda = +document.getElementById('decay_lambda').value;
            settings.decay.weekend_mode = document.getElementById('weekend_mode').value;
            settings.tiers.green_max = +document.getElementById('tier_green_max').value;
            settings.tiers.yellow_max = +document.getElementById('tier_yellow_max').value;

            try {
                const r = await fetch('/api/ueba/settings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(settings)
                });
                if (r.ok) {
                    showToast('ì„¤ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
                } else {
                    showToast('ì €ì¥ ì‹¤íŒ¨', 'error');
                }
            } catch (e) {
                showToast('ì €ì¥ ì‹¤íŒ¨: ' + e.message, 'error');
            }
        }

        function showToast(msg, type) {
            const toast = document.getElementById('toast');
            toast.textContent = msg;
            toast.className = 'toast ' + type + ' show';
            setTimeout(() => toast.classList.remove('show'), 3000);
        }

        loadSettings();
    </script>
</body>
</html>
