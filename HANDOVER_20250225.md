# SafePC CEP 시스템 인수인계서 (2026-02-25)

## 이번 컨텍스트 작업 요약

### 1. Flink 테이블 동적 스키마 변경

**변경 전 (하드코딩):**
```sql
cefExtensions ROW<suid, suser, src, act, outcome, fname, ...> -- 50+ 필드 고정
```

**변경 후 (동적):**
```sql
cefExtensions MAP<STRING, STRING>  -- 어떤 필드든 동적 처리
userId AS cefExtensions['suid']    -- 편의 alias
```

**수정 파일:** `internal/cep/services/flink.go`

### 2. SQL Builder 동적 필드 접근

**변경 전:**
```sql
outcome = 'blocked'
```

**변경 후:**
```sql
cefExtensions['outcome'] = 'blocked'
```

**수정 파일:** `internal/cep/services/sql_builder.go`
- `isBaseField()` 함수 추가: msgId, hostname, userId 등 기본 필드 구분
- CEF extension 필드는 `cefExtensions['필드명']` 형식으로 변환

### 3. Field Meta 버그 수정

**문제:** 마이그레이션 분석 시 이벤트 0개 반환

**원인:**
1. `msgId` 필드가 text 타입 → aggregation 불가
2. `cefExtensions` 대신 `attrs`만 확인

**수정 (`internal/common/fieldmeta.go`):**
```go
// msgId → msgId.keyword
"terms": map[string]interface{}{"field": "msgId.keyword", "size": 100}

// cefExtensions 추가
if cef, ok := doc["cefExtensions"].(map[string]interface{}); ok {
    for k := range cef { fieldSet[k] = true }
}
```

### 4. Confluence 문서 전면 개정

**페이지:** https://markany.atlassian.net/wiki/spaces/vz4L8SnnRZLr/pages/1691484182/CEP
**버전:** 16 → 23

**추가된 내용:**
- 서버 구성 및 Docker 컨테이너 역할
- 데이터 흐름 상세 (Log Adapter → Kafka → Flink → Alert)
- 마이그레이션 프로세스 및 Field Meta 스키마 예제
- CEP 규칙 JSON 실제 요청 예제 (단일/집계/순차/동시 패턴)
- Flink Job 생성 과정
- 규칙 수정/삭제 시 Job 재시작 동작
- 신규 사이트 구축 시나리오 (Phase 1~5)

---

## 현재 시스템 상태

### 서비스 포트
| 서비스 | 포트 |
|--------|------|
| CEP API | 48084 |
| Flink SQL Gateway | 48083 |
| Flink REST API | 48081 |
| OpenSearch | 49200 |
| Dashboard | 48501 |

### 테스트 결과
```bash
# 마이그레이션 분석 - 정상
curl -s "http://203.229.154.49:48084/api/field-meta/analyze" -X POST \
  -H 'Content-Type: application/json' -d '{"days": 7}'
# → 13개 이벤트, 필드 정상 추출

# SQL 빌드 - 정상
curl -s "http://203.229.154.49:48084/api/build-sql" -X POST \
  -H 'Content-Type: application/json' \
  -d '{"events":[{"msgId":"MESSAGE_DEVICE_USAGE","conditions":[{"field":"outcome","op":"eq","value":"blocked"}]}]}'
# → SELECT userId, 1 as cnt FROM events WHERE msgId = 'MESSAGE_DEVICE_USAGE' AND cefExtensions['outcome'] = 'blocked'

# 로그 저장 - 정상
# 271,881건 저장됨
```

---

## 유의사항

### 1. OpenSearch 필드 타입
- `msgId`, `userId` 등 문자열 필드는 `.keyword` 서브필드 사용 필요
- aggregation, term 쿼리 시 `.keyword` 붙여야 함

### 2. 로그 구조
현재 로그는 `cefExtensions` 객체에 CEF 필드 저장:
```json
{
  "msgId": "MESSAGE_DEVICE_USAGE",
  "hostname": "HOST",
  "cefExtensions": {
    "suid": "kim",
    "outcome": "blocked",
    "fname": "file.txt"
  }
}
```

### 3. 규칙 수정 시 Job 처리
- `PUT /api/rules/:id` 호출 시 기존 Flink Job 자동 취소 후 새 Job 제출
- `enabled: false`로 수정하면 Job만 취소

### 4. 신규 사이트 구축 순서
1. 인프라 배포 (Kafka, Flink, OpenSearch, CEP)
2. 로그 수집 (며칠간 LogSink로 축적)
3. 마이그레이션 (field-meta/analyze)
4. 규칙 생성 (프론트 UI → POST /api/rules)
5. 운영

---

## 수정된 파일 목록

```
internal/cep/services/flink.go       # Flink 테이블 동적 스키마
internal/cep/services/sql_builder.go # cefExtensions['field'] 접근
internal/common/fieldmeta.go         # msgId.keyword, cefExtensions 추가
docs/CEP_CONFLUENCE.md               # 문서 전면 개정
```

---

## 배포 명령어

```bash
# 파일 업로드
sshpass -p 'M@rkAny' scp -r internal/ root@203.229.154.49:/Safepc/SafePC/

# CEP 빌드 & 재시작
sshpass -p 'M@rkAny' ssh root@203.229.154.49 '
cd /Safepc/siem
docker-compose build cep
docker-compose down cep && docker-compose up -d cep
'
```

---

## 다음 작업 제안

1. **UEBA 문서화** - CEP와 동일하게 Confluence 문서 작성
2. **인덱스 템플릿** - msgId 등 필드를 keyword 타입으로 자동 매핑
3. **대시보드 규칙 빌더** - field-meta 기반 동적 UI 연동 확인
